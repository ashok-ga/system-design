
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ashok-ga.github.io/system-design/lld/module1/LLD_Common_JAVA/">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>LLD Systems — Consolidated Specs & Code - System Design Hub</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lld-systems-consolidated-specs-code" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="System Design Hub" class="md-header__button md-logo" aria-label="System Design Hub" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            System Design Hub
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              LLD Systems — Consolidated Specs &amp; Code
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ashok-ga/system-design" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ashok-ga/system-design
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="System Design Hub" class="md-nav__button md-logo" aria-label="System Design Hub" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    System Design Hub
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ashok-ga/system-design" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ashok-ga/system-design
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    High-Level Design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            High-Level Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hld/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hld/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hld/de-shaw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DE Shaw
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Low-Level Design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Low-Level Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../de-shaw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DE Shaw
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Questions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Module 2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../assets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Assets
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    References
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../CONTRIBUTING.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parking-lot" class="md-nav__link">
    <span class="md-ellipsis">
      Parking Lot
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parking Lot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Java Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#movie-booking" class="md-nav__link">
    <span class="md-ellipsis">
      Movie Booking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Movie Booking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-implementation_1" class="md-nav__link">
    <span class="md-ellipsis">
      Java Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#food-delivery" class="md-nav__link">
    <span class="md-ellipsis">
      Food Delivery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Food Delivery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-implementation_2" class="md-nav__link">
    <span class="md-ellipsis">
      Java Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ride-sharing" class="md-nav__link">
    <span class="md-ellipsis">
      Ride Sharing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ride Sharing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-implementation_3" class="md-nav__link">
    <span class="md-ellipsis">
      Java Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chat-app" class="md-nav__link">
    <span class="md-ellipsis">
      Chat App
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chat App">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-implementation_4" class="md-nav__link">
    <span class="md-ellipsis">
      Java Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-store" class="md-nav__link">
    <span class="md-ellipsis">
      File Store
    </span>
  </a>
  
    <nav class="md-nav" aria-label="File Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-implementation_5" class="md-nav__link">
    <span class="md-ellipsis">
      Java Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instagram-feed" class="md-nav__link">
    <span class="md-ellipsis">
      Instagram Feed
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Instagram Feed">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-implementation_6" class="md-nav__link">
    <span class="md-ellipsis">
      Java Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#meeting-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Meeting Scheduler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Meeting Scheduler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-implementation_7" class="md-nav__link">
    <span class="md-ellipsis">
      Java Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lld-systems-consolidated-specs-code">LLD Systems — Consolidated Specs &amp; Code<a class="headerlink" href="#lld-systems-consolidated-specs-code" title="Permanent link">&para;</a></h1>
<p>This Markdown bundles the original comment specs and full Java implementations for multiple LLD exercises, each in its own section.</p>
<h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#parking-lot">Parking Lot</a></li>
<li><a href="#movie-booking">Movie Booking</a></li>
<li><a href="#food-delivery">Food Delivery</a></li>
<li><a href="#ride-sharing">Ride Sharing</a></li>
<li><a href="#chat-app">Chat App</a></li>
<li><a href="#file-store">File Store</a></li>
<li><a href="#instagram-feed">Instagram Feed</a></li>
<li><a href="#meeting-scheduler">Meeting Scheduler</a></li>
</ol>
<h2 id="parking-lot">Parking Lot<a class="headerlink" href="#parking-lot" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>/*
Template -&gt;
1) define functional requirements
   - Single lot with levels, slots typed by vehicle (BIKE/CAR).
   - Entry: allocate nearest free slot by type, create ticket.
   - Exit: compute fee (base + hourly rounded up), release slot.
   - Query: availability per level &amp; type.
   - Keep it concurrency-safe (basic locking), in-memory only.

2) define entities / actors
   Actors: Driver, Gate (Entry/Exit)
   Entities: Lot, Level, Slot(OPEN/OCCUPIED/MAINTENANCE, vehicleType), Ticket(OPEN/CLOSED), PricingRule

3) define apis - get/post/put, request, response
   GET  /availability?lotId=... -&gt; { levelId -&gt; {CAR:n, BIKE:n} }
   POST /entry                  {lotId, gateId, vehicleType, plate} -&gt; {ticketId, slotId, entryAt}
   POST /exit                   {ticketId} -&gt; {amount, exitAt, status}
   (Implemented as method calls in the Controller facade)

4) define services involved
   SlotService   - allocate/release slots (nearest level first)
   TicketService - issue/close tickets, orchestrates pricing + slot ops
   PricingService- compute amount (base + hourly)
   AvailabilityService - compute free counts excluding OCCUPIED/MAINTENANCE

5) define db schema - what all tables are required, what are the columns, what are the keys
   (In-memory for interview; relational sketch)
   lot(id PK, name, tz)
   level(id PK, lot_id FK, idx, name)
   slot(id PK, level_id FK, code UNIQUE(level_id, code), vehicle_type, status)
   pricing_rule(id PK, lot_id FK, vehicle_type, base_fee, hourly_rate)
   ticket(id PK, lot_id FK, slot_id FK, vehicle_type, plate, entry_at, exit_at, amount, status)
*/
</code></pre></div>
<h3 id="java-implementation">Java Implementation<a class="headerlink" href="#java-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">Template -&gt;</span>
<span class="cm">1) define functional requirements</span>
<span class="cm">   - Single lot with levels, slots typed by vehicle (BIKE/CAR).</span>
<span class="cm">   - Entry: allocate nearest free slot by type, create ticket.</span>
<span class="cm">   - Exit: compute fee (base + hourly rounded up), release slot.</span>
<span class="cm">   - Query: availability per level &amp; type.</span>
<span class="cm">   - Keep it concurrency-safe (basic locking), in-memory only.</span>

<span class="cm">2) define entities / actors</span>
<span class="cm">   Actors: Driver, Gate (Entry/Exit)</span>
<span class="cm">   Entities: Lot, Level, Slot(OPEN/OCCUPIED/MAINTENANCE, vehicleType), Ticket(OPEN/CLOSED), PricingRule</span>

<span class="cm">3) define apis - get/post/put, request, response</span>
<span class="cm">   GET  /availability?lotId=... -&gt; { levelId -&gt; {CAR:n, BIKE:n} }</span>
<span class="cm">   POST /entry                  {lotId, gateId, vehicleType, plate} -&gt; {ticketId, slotId, entryAt}</span>
<span class="cm">   POST /exit                   {ticketId} -&gt; {amount, exitAt, status}</span>
<span class="cm">   (Implemented as method calls in the Controller facade)</span>

<span class="cm">4) define services involved</span>
<span class="cm">   SlotService   - allocate/release slots (nearest level first)</span>
<span class="cm">   TicketService - issue/close tickets, orchestrates pricing + slot ops</span>
<span class="cm">   PricingService- compute amount (base + hourly)</span>
<span class="cm">   AvailabilityService - compute free counts excluding OCCUPIED/MAINTENANCE</span>

<span class="cm">5) define db schema - what all tables are required, what are the columns, what are the keys</span>
<span class="cm">   (In-memory for interview; relational sketch)</span>
<span class="cm">   lot(id PK, name, tz)</span>
<span class="cm">   level(id PK, lot_id FK, idx, name)</span>
<span class="cm">   slot(id PK, level_id FK, code UNIQUE(level_id, code), vehicle_type, status)</span>
<span class="cm">   pricing_rule(id PK, lot_id FK, vehicle_type, base_fee, hourly_rate)</span>
<span class="cm">   ticket(id PK, lot_id FK, slot_id FK, vehicle_type, plate, entry_at, exit_at, amount, status)</span>
<span class="cm">*/</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="cm">/* ===== Domain ===== */</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">VehicleType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">BIKE</span><span class="p">,</span><span class="w"> </span><span class="n">CAR</span><span class="w"> </span><span class="p">}</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">SlotStatus</span><span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="n">OPEN</span><span class="p">,</span><span class="w"> </span><span class="n">OCCUPIED</span><span class="p">,</span><span class="w"> </span><span class="n">MAINTENANCE</span><span class="w"> </span><span class="p">}</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">TicketStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">OPEN</span><span class="p">,</span><span class="w"> </span><span class="n">CLOSED</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Lot</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ZoneId</span><span class="w"> </span><span class="n">zone</span><span class="p">;</span><span class="w"> </span><span class="n">Lot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="n">ZoneId</span><span class="w"> </span><span class="n">z</span><span class="p">){</span><span class="n">id</span><span class="o">=</span><span class="n">i</span><span class="p">;</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="n">zone</span><span class="o">=</span><span class="n">z</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Level</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span><span class="w"> </span><span class="n">Level</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">id</span><span class="o">=</span><span class="n">i</span><span class="p">;</span><span class="n">lotId</span><span class="o">=</span><span class="n">l</span><span class="p">;</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="n">idx</span><span class="o">=</span><span class="n">x</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Slot</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">levelId</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">VehicleType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">SlotStatus</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="n">SlotStatus</span><span class="p">.</span><span class="na">OPEN</span><span class="p">;</span>
<span class="w">    </span><span class="n">Slot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">lvl</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="n">VehicleType</span><span class="w"> </span><span class="n">t</span><span class="p">){</span><span class="n">id</span><span class="o">=</span><span class="n">i</span><span class="p">;</span><span class="n">levelId</span><span class="o">=</span><span class="n">lvl</span><span class="p">;</span><span class="n">code</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="n">type</span><span class="o">=</span><span class="n">t</span><span class="p">;}</span>
<span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PricingRule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">lotId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">VehicleType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">baseFee</span><span class="p">,</span><span class="w"> </span><span class="n">hourlyRate</span><span class="p">;</span>
<span class="w">    </span><span class="n">PricingRule</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="n">VehicleType</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">h</span><span class="p">){</span><span class="n">id</span><span class="o">=</span><span class="n">i</span><span class="p">;</span><span class="n">lotId</span><span class="o">=</span><span class="n">l</span><span class="p">;</span><span class="n">type</span><span class="o">=</span><span class="n">t</span><span class="p">;</span><span class="n">baseFee</span><span class="o">=</span><span class="n">b</span><span class="p">;</span><span class="n">hourlyRate</span><span class="o">=</span><span class="n">h</span><span class="p">;}</span>
<span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Ticket</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">slotId</span><span class="p">,</span><span class="w"> </span><span class="n">plate</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">VehicleType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">entryAt</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">exitAt</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Double</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">TicketStatus</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="n">TicketStatus</span><span class="p">.</span><span class="na">OPEN</span><span class="p">;</span>
<span class="w">    </span><span class="n">Ticket</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="n">VehicleType</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="n">Instant</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="n">id</span><span class="o">=</span><span class="n">i</span><span class="p">;</span><span class="n">lotId</span><span class="o">=</span><span class="n">l</span><span class="p">;</span><span class="n">slotId</span><span class="o">=</span><span class="n">s</span><span class="p">;</span><span class="n">type</span><span class="o">=</span><span class="n">t</span><span class="p">;</span><span class="n">plate</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="n">entryAt</span><span class="o">=</span><span class="n">e</span><span class="p">;}</span>
<span class="p">}</span>

<span class="cm">/* ===== Simple Repos (in-memory) ===== */</span>
<span class="kd">class</span> <span class="nc">Ids</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">seq</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">seq</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">();}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">LotsRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Lot</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Lot</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Lot</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Lot</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">LevelsRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Level</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Level</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Level</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Level</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byLot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">lotId</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="na">lotId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">lotId</span><span class="p">)).</span><span class="na">sorted</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparingInt</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="na">idx</span><span class="p">)).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">SlotsRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Slot</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Slot</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Slot</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Slot</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Slot</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byLevel</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">levelId</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="na">levelId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">levelId</span><span class="p">)).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">PricingRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">PricingRule</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">PricingRule</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">PricingRule</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">p</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">PricingRule</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byLotType</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleType</span><span class="w"> </span><span class="n">t</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="na">lotId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">lotId</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">r</span><span class="p">.</span><span class="na">type</span><span class="o">==</span><span class="n">t</span><span class="p">).</span><span class="na">findFirst</span><span class="p">();}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">TicketsRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Ticket</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Ticket</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Ticket</span><span class="w"> </span><span class="n">t</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">t</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Ticket</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span>
<span class="p">}</span>

<span class="cm">/* ===== Exceptions ===== */</span>
<span class="kd">class</span> <span class="nc">DomainException</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">RuntimeException</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">m</span><span class="p">){</span><span class="kd">super</span><span class="p">(</span><span class="n">m</span><span class="p">);}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Services ===== */</span>
<span class="kd">class</span> <span class="nc">PricingService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PricingRepo</span><span class="w"> </span><span class="n">pricing</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LotsRepo</span><span class="w"> </span><span class="n">lots</span><span class="p">;</span>
<span class="w">    </span><span class="n">PricingService</span><span class="p">(</span><span class="n">PricingRepo</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">LotsRepo</span><span class="w"> </span><span class="n">l</span><span class="p">){</span><span class="n">pricing</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="n">lots</span><span class="o">=</span><span class="n">l</span><span class="p">;}</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">exit</span><span class="p">){</span>
<span class="w">        </span><span class="n">PricingRule</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="na">byLotType</span><span class="p">(</span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;pricing missing&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">secs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">between</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">exit</span><span class="p">).</span><span class="na">getSeconds</span><span class="p">());</span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">hrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">secs</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="mi">0</span><span class="p">:((</span><span class="n">secs</span><span class="o">+</span><span class="mi">3599</span><span class="p">)</span><span class="o">/</span><span class="mi">3600</span><span class="p">);</span><span class="w"> </span><span class="c1">// round up started hour</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">baseFee</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">hourlyRate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hrs</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="n">total</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">SlotService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SlotsRepo</span><span class="w"> </span><span class="n">slots</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LevelsRepo</span><span class="w"> </span><span class="n">levels</span><span class="p">;</span>
<span class="w">    </span><span class="n">SlotService</span><span class="p">(</span><span class="n">SlotsRepo</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">LevelsRepo</span><span class="w"> </span><span class="n">l</span><span class="p">){</span><span class="n">slots</span><span class="o">=</span><span class="n">s</span><span class="p">;</span><span class="n">levels</span><span class="o">=</span><span class="n">l</span><span class="p">;}</span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Slot</span><span class="w"> </span><span class="nf">allocateNearest</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleType</span><span class="w"> </span><span class="n">type</span><span class="p">){</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Level</span><span class="w"> </span><span class="n">lvl</span><span class="p">:</span><span class="w"> </span><span class="n">levels</span><span class="p">.</span><span class="na">byLot</span><span class="p">(</span><span class="n">lotId</span><span class="p">)){</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Slot</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">slots</span><span class="p">.</span><span class="na">byLevel</span><span class="p">(</span><span class="n">lvl</span><span class="p">.</span><span class="na">id</span><span class="p">)){</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">type</span><span class="o">==</span><span class="n">type</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">status</span><span class="o">==</span><span class="n">SlotStatus</span><span class="p">.</span><span class="na">OPEN</span><span class="p">){</span>
<span class="w">                    </span><span class="n">s</span><span class="p">.</span><span class="na">status</span><span class="o">=</span><span class="n">SlotStatus</span><span class="p">.</span><span class="na">OCCUPIED</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">slots</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no free slot&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">release</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">slotId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Slot</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slots</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">slotId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;slot not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">s</span><span class="p">.</span><span class="na">status</span><span class="o">=</span><span class="n">SlotStatus</span><span class="p">.</span><span class="na">OPEN</span><span class="p">;</span><span class="w"> </span><span class="n">slots</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">TicketService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TicketsRepo</span><span class="w"> </span><span class="n">tickets</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SlotService</span><span class="w"> </span><span class="n">slotSvc</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PricingService</span><span class="w"> </span><span class="n">pricingSvc</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">TicketService</span><span class="p">(</span><span class="n">TicketsRepo</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">SlotService</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">PricingService</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">tickets</span><span class="o">=</span><span class="n">t</span><span class="p">;</span><span class="n">slotSvc</span><span class="o">=</span><span class="n">s</span><span class="p">;</span><span class="n">pricingSvc</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Ticket</span><span class="w"> </span><span class="nf">entry</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">plate</span><span class="p">){</span>
<span class="w">        </span><span class="n">Slot</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slotSvc</span><span class="p">.</span><span class="na">allocateNearest</span><span class="p">(</span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="w">        </span><span class="n">Ticket</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ticket</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;tkt&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">plate</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">());</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tickets</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Ticket</span><span class="w"> </span><span class="nf">exit</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ticketId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Ticket</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tickets</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">ticketId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;ticket not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">status</span><span class="o">==</span><span class="n">TicketStatus</span><span class="p">.</span><span class="na">CLOSED</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">exitAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pricingSvc</span><span class="p">.</span><span class="na">compute</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">type</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">entryAt</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">exitAt</span><span class="p">);</span>
<span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TicketStatus</span><span class="p">.</span><span class="na">CLOSED</span><span class="p">;</span>
<span class="w">        </span><span class="n">tickets</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="w">        </span><span class="n">slotSvc</span><span class="p">.</span><span class="na">release</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">slotId</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">AvailabilityService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LevelsRepo</span><span class="w"> </span><span class="n">levels</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SlotsRepo</span><span class="w"> </span><span class="n">slots</span><span class="p">;</span>
<span class="w">    </span><span class="n">AvailabilityService</span><span class="p">(</span><span class="n">LevelsRepo</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">SlotsRepo</span><span class="w"> </span><span class="n">s</span><span class="p">){</span><span class="n">levels</span><span class="o">=</span><span class="n">l</span><span class="p">;</span><span class="n">slots</span><span class="o">=</span><span class="n">s</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">VehicleType</span><span class="p">,</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">availability</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">lotId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">VehicleType</span><span class="p">,</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Level</span><span class="w"> </span><span class="n">lvl</span><span class="p">:</span><span class="w"> </span><span class="n">levels</span><span class="p">.</span><span class="na">byLot</span><span class="p">(</span><span class="n">lotId</span><span class="p">)){</span>
<span class="w">            </span><span class="n">EnumMap</span><span class="o">&lt;</span><span class="n">VehicleType</span><span class="p">,</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">EnumMap</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">VehicleType</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VehicleType</span><span class="w"> </span><span class="n">vt</span><span class="p">:</span><span class="w"> </span><span class="n">VehicleType</span><span class="p">.</span><span class="na">values</span><span class="p">())</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">vt</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Slot</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">slots</span><span class="p">.</span><span class="na">byLevel</span><span class="p">(</span><span class="n">lvl</span><span class="p">.</span><span class="na">id</span><span class="p">)){</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">status</span><span class="o">==</span><span class="n">SlotStatus</span><span class="p">.</span><span class="na">OPEN</span><span class="p">)</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">compute</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">type</span><span class="p">,(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lvl</span><span class="p">.</span><span class="na">name</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Controller (facade mirroring APIs) ===== */</span>
<span class="kd">class</span> <span class="nc">ParkingController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AvailabilityService</span><span class="w"> </span><span class="n">avail</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TicketService</span><span class="w"> </span><span class="n">tickets</span><span class="p">;</span>
<span class="w">    </span><span class="n">ParkingController</span><span class="p">(</span><span class="n">AvailabilityService</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">TicketService</span><span class="w"> </span><span class="n">t</span><span class="p">){</span><span class="n">avail</span><span class="o">=</span><span class="n">a</span><span class="p">;</span><span class="n">tickets</span><span class="o">=</span><span class="n">t</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">VehicleType</span><span class="p">,</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getAvailability</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">lotId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">avail</span><span class="p">.</span><span class="na">availability</span><span class="p">(</span><span class="n">lotId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Ticket</span><span class="w"> </span><span class="nf">postEntry</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">plate</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">tickets</span><span class="p">.</span><span class="na">entry</span><span class="p">(</span><span class="n">lotId</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">plate</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Ticket</span><span class="w"> </span><span class="nf">postExit</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ticketId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">tickets</span><span class="p">.</span><span class="na">exit</span><span class="p">(</span><span class="n">ticketId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Bootstrap / Demo (kept tiny for 40-min scope) ===== */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ParkingLot40Min</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ids</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Repos</span>
<span class="w">        </span><span class="n">LotsRepo</span><span class="w"> </span><span class="n">lots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LotsRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">LevelsRepo</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LevelsRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">SlotsRepo</span><span class="w"> </span><span class="n">slots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SlotsRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">PricingRepo</span><span class="w"> </span><span class="n">pricing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PricingRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">TicketsRepo</span><span class="w"> </span><span class="n">tickets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TicketsRepo</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Seed a small lot</span>
<span class="w">        </span><span class="n">Lot</span><span class="w"> </span><span class="n">lot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lots</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Lot</span><span class="p">(</span><span class="s">&quot;LOT-1&quot;</span><span class="p">,</span><span class="s">&quot;HSR Central&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ZoneId</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;Asia/Kolkata&quot;</span><span class="p">)));</span>
<span class="w">        </span><span class="n">Level</span><span class="w"> </span><span class="n">L0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levels</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Level</span><span class="p">(</span><span class="s">&quot;L0&quot;</span><span class="p">,</span><span class="s">&quot;LOT-1&quot;</span><span class="p">,</span><span class="s">&quot;Ground&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="n">Level</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levels</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Level</span><span class="p">(</span><span class="s">&quot;L1&quot;</span><span class="p">,</span><span class="s">&quot;LOT-1&quot;</span><span class="p">,</span><span class="s">&quot;P1&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// Few slots</span>
<span class="w">        </span><span class="n">slots</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Slot</span><span class="p">(</span><span class="s">&quot;S1&quot;</span><span class="p">,</span><span class="s">&quot;L0&quot;</span><span class="p">,</span><span class="s">&quot;C-001&quot;</span><span class="p">,</span><span class="n">VehicleType</span><span class="p">.</span><span class="na">CAR</span><span class="p">));</span>
<span class="w">        </span><span class="n">slots</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Slot</span><span class="p">(</span><span class="s">&quot;S2&quot;</span><span class="p">,</span><span class="s">&quot;L0&quot;</span><span class="p">,</span><span class="s">&quot;C-002&quot;</span><span class="p">,</span><span class="n">VehicleType</span><span class="p">.</span><span class="na">CAR</span><span class="p">));</span>
<span class="w">        </span><span class="n">slots</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Slot</span><span class="p">(</span><span class="s">&quot;S3&quot;</span><span class="p">,</span><span class="s">&quot;L1&quot;</span><span class="p">,</span><span class="s">&quot;B-001&quot;</span><span class="p">,</span><span class="n">VehicleType</span><span class="p">.</span><span class="na">BIKE</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// Pricing</span>
<span class="w">        </span><span class="n">pricing</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PricingRule</span><span class="p">(</span><span class="s">&quot;PR-CAR&quot;</span><span class="p">,</span><span class="s">&quot;LOT-1&quot;</span><span class="p">,</span><span class="n">VehicleType</span><span class="p">.</span><span class="na">CAR</span><span class="p">,</span><span class="w">  </span><span class="mf">20.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">));</span>
<span class="w">        </span><span class="n">pricing</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PricingRule</span><span class="p">(</span><span class="s">&quot;PR-BIKE&quot;</span><span class="p">,</span><span class="s">&quot;LOT-1&quot;</span><span class="p">,</span><span class="n">VehicleType</span><span class="p">.</span><span class="na">BIKE</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Services + Controller</span>
<span class="w">        </span><span class="n">PricingService</span><span class="w"> </span><span class="n">pricingSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PricingService</span><span class="p">(</span><span class="n">pricing</span><span class="p">,</span><span class="w"> </span><span class="n">lots</span><span class="p">);</span>
<span class="w">        </span><span class="n">SlotService</span><span class="w"> </span><span class="n">slotSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SlotService</span><span class="p">(</span><span class="n">slots</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="p">);</span>
<span class="w">        </span><span class="n">TicketService</span><span class="w"> </span><span class="n">ticketSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TicketService</span><span class="p">(</span><span class="n">tickets</span><span class="p">,</span><span class="w"> </span><span class="n">slotSvc</span><span class="p">,</span><span class="w"> </span><span class="n">pricingSvc</span><span class="p">,</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">AvailabilityService</span><span class="w"> </span><span class="n">av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AvailabilityService</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span><span class="w"> </span><span class="n">slots</span><span class="p">);</span>
<span class="w">        </span><span class="n">ParkingController</span><span class="w"> </span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ParkingController</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">ticketSvc</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// --- Demo as API calls ---</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;GET /availability -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getAvailability</span><span class="p">(</span><span class="s">&quot;LOT-1&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Ticket</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postEntry</span><span class="p">(</span><span class="s">&quot;LOT-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleType</span><span class="p">.</span><span class="na">CAR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;KA-01-AB-1234&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;POST /entry -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; slot=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="na">slotId</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;GET /availability -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getAvailability</span><span class="p">(</span><span class="s">&quot;LOT-1&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1200</span><span class="p">);</span><span class="w"> </span><span class="c1">// simulate time</span>
<span class="w">        </span><span class="n">Ticket</span><span class="w"> </span><span class="n">closed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postExit</span><span class="p">(</span><span class="n">t1</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;POST /exit -&gt; ticket=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">closed</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; amount=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">closed</span><span class="p">.</span><span class="na">amount</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;GET /availability -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getAvailability</span><span class="p">(</span><span class="s">&quot;LOT-1&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sleep</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ms</span><span class="p">){</span><span class="w"> </span><span class="k">try</span><span class="p">{</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">ms</span><span class="p">);}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ignored</span><span class="p">){}</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="movie-booking">Movie Booking<a class="headerlink" href="#movie-booking" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>/*
Template -&gt;
1) define functional requirements
   - Browse shows for a movie in a city &amp; date.
   - View seat map for a show: FREE / HELD (by TTL hold) / BOOKED.
   - Hold seats with TTL (e.g., 5 minutes). Holds block others but auto-expire on read.
   - Confirm booking from a valid hold; mark seats BOOKED; compute price.
   - Confirm payment (stub), return e-ticket code.
   - In-memory only, concurrency-safe per Show (locks). Keep it 40-min friendly.

2) define entities / actors
   Actors: User, System (Seat Inventory), Payment Gateway (stub)
   Entities: Movie, Theater, Screen, Seat, Show, SeatHold, Booking, Payment

3) define apis - get/post/put, request, response
   GET  /movies/{movieId}/shows?city=...&amp;date=YYYY-MM-DD
        -&gt; [{showId, theater, screen, startAt, basePrice}]
   GET  /shows/{showId}/seats
        -&gt; { showId, seats: [{seatId,row,col,type,status:FREE|HELD|BOOKED}], holdTtlSec }
   POST /shows/{showId}/hold
        { userId, seatIds:[...], ttlSec }
        -&gt; { holdId, expiresAt }
   POST /bookings
        { holdId, userId }
        -&gt; { bookingId, amount, seats:[...], qr }
   POST /payments/confirm
        { bookingId, method, txnRef? }
        -&gt; { paymentId, status }

4) define services involved
   ShowSearchService     - list shows for movie/city/date.
   SeatInventoryService  - seat map, create hold (per-show lock), check expiries.
   BookingService        - confirm booking from hold (per-show lock), pricing.
   PaymentService        - stub payment confirmation.
   IdGenerator           - simple IDs.

5) define db schema - what all tables are required, what are the columns, what are the keys
   movie(id PK, title, duration_min)
   theater(id PK, city, name)
   screen(id PK, theater_id FK, name, rows, cols)
   seat(id PK, screen_id FK, row, col, type ENUM)
   show(id PK, movie_id FK, screen_id FK, start_at, base_price NUM, status)
   seat_hold(id PK, show_id FK, user_id, seat_ids JSON, expires_at, active)
      INDEX(show_id, active, expires_at)
   booking(id PK, show_id FK, user_id, seat_ids JSON, amount NUM, status, qr)
      INDEX(show_id, status)
   payment(id PK, booking_id FK UNIQUE, method, amount NUM, status, txn_ref, paid_at)
*/
</code></pre></div>
<h3 id="java-implementation_1">Java Implementation<a class="headerlink" href="#java-implementation_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">Template -&gt;</span>
<span class="cm">1) define functional requirements</span>
<span class="cm">   - Browse shows for a movie in a city &amp; date.</span>
<span class="cm">   - View seat map for a show: FREE / HELD (by TTL hold) / BOOKED.</span>
<span class="cm">   - Hold seats with TTL (e.g., 5 minutes). Holds block others but auto-expire on read.</span>
<span class="cm">   - Confirm booking from a valid hold; mark seats BOOKED; compute price.</span>
<span class="cm">   - Confirm payment (stub), return e-ticket code.</span>
<span class="cm">   - In-memory only, concurrency-safe per Show (locks). Keep it 40-min friendly.</span>

<span class="cm">2) define entities / actors</span>
<span class="cm">   Actors: User, System (Seat Inventory), Payment Gateway (stub)</span>
<span class="cm">   Entities: Movie, Theater, Screen, Seat, Show, SeatHold, Booking, Payment</span>

<span class="cm">3) define apis - get/post/put, request, response</span>
<span class="cm">   GET  /movies/{movieId}/shows?city=...&amp;date=YYYY-MM-DD</span>
<span class="cm">        -&gt; [{showId, theater, screen, startAt, basePrice}]</span>
<span class="cm">   GET  /shows/{showId}/seats</span>
<span class="cm">        -&gt; { showId, seats: [{seatId,row,col,type,status:FREE|HELD|BOOKED}], holdTtlSec }</span>
<span class="cm">   POST /shows/{showId}/hold</span>
<span class="cm">        { userId, seatIds:[...], ttlSec }</span>
<span class="cm">        -&gt; { holdId, expiresAt }</span>
<span class="cm">   POST /bookings</span>
<span class="cm">        { holdId, userId }</span>
<span class="cm">        -&gt; { bookingId, amount, seats:[...], qr }</span>
<span class="cm">   POST /payments/confirm</span>
<span class="cm">        { bookingId, method, txnRef? }</span>
<span class="cm">        -&gt; { paymentId, status }</span>

<span class="cm">4) define services involved</span>
<span class="cm">   ShowSearchService     - list shows for movie/city/date.</span>
<span class="cm">   SeatInventoryService  - seat map, create hold (per-show lock), check expiries.</span>
<span class="cm">   BookingService        - confirm booking from hold (per-show lock), pricing.</span>
<span class="cm">   PaymentService        - stub payment confirmation.</span>
<span class="cm">   IdGenerator           - simple IDs.</span>

<span class="cm">5) define db schema - what all tables are required, what are the columns, what are the keys</span>
<span class="cm">   movie(id PK, title, duration_min)</span>
<span class="cm">   theater(id PK, city, name)</span>
<span class="cm">   screen(id PK, theater_id FK, name, rows, cols)</span>
<span class="cm">   seat(id PK, screen_id FK, row, col, type ENUM)</span>
<span class="cm">   show(id PK, movie_id FK, screen_id FK, start_at, base_price NUM, status)</span>
<span class="cm">   seat_hold(id PK, show_id FK, user_id, seat_ids JSON, expires_at, active)</span>
<span class="cm">      INDEX(show_id, active, expires_at)</span>
<span class="cm">   booking(id PK, show_id FK, user_id, seat_ids JSON, amount NUM, status, qr)</span>
<span class="cm">      INDEX(show_id, status)</span>
<span class="cm">   payment(id PK, booking_id FK UNIQUE, method, amount NUM, status, txn_ref, paid_at)</span>
<span class="cm">*/</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="cm">/* ===== Enums ===== */</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">SeatType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">REGULAR</span><span class="p">,</span><span class="w"> </span><span class="n">PREMIUM</span><span class="w"> </span><span class="p">}</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">BookingStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">PENDING</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIRMED</span><span class="p">,</span><span class="w"> </span><span class="n">CANCELLED</span><span class="w"> </span><span class="p">}</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">PENDING</span><span class="p">,</span><span class="w"> </span><span class="n">PAID</span><span class="p">,</span><span class="w"> </span><span class="n">FAILED</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Domain ===== */</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Movie</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">durationMin</span><span class="p">;</span><span class="w"> </span><span class="n">Movie</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">title</span><span class="o">=</span><span class="n">title</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">durationMin</span><span class="o">=</span><span class="n">d</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Theater</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="n">Theater</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">city</span><span class="o">=</span><span class="n">city</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">name</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Screen</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">theaterId</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="n">cols</span><span class="p">;</span><span class="w"> </span><span class="n">Screen</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">th</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">theaterId</span><span class="o">=</span><span class="n">th</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">name</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">rows</span><span class="o">=</span><span class="n">r</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">cols</span><span class="o">=</span><span class="n">c</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Seat</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">screenId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SeatType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="n">Seat</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">sid</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="n">SeatType</span><span class="w"> </span><span class="n">t</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">screenId</span><span class="o">=</span><span class="n">sid</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">row</span><span class="o">=</span><span class="n">r</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">col</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">type</span><span class="o">=</span><span class="n">t</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Show</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">movieId</span><span class="p">,</span><span class="w"> </span><span class="n">screenId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ZonedDateTime</span><span class="w"> </span><span class="n">startAt</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">basePrice</span><span class="p">;</span><span class="w"> </span><span class="n">Show</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">sc</span><span class="p">,</span><span class="n">ZonedDateTime</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">movieId</span><span class="o">=</span><span class="n">mid</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">screenId</span><span class="o">=</span><span class="n">sc</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">startAt</span><span class="o">=</span><span class="n">t</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">basePrice</span><span class="o">=</span><span class="n">p</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SeatHold</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">showId</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">seatIds</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">expiresAt</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">active</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">SeatHold</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">showId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">seatIds</span><span class="p">,</span><span class="n">Instant</span><span class="w"> </span><span class="n">exp</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">showId</span><span class="o">=</span><span class="n">showId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">userId</span><span class="o">=</span><span class="n">userId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">seatIds</span><span class="o">=</span><span class="n">seatIds</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">expiresAt</span><span class="o">=</span><span class="n">exp</span><span class="p">;}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Booking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">showId</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">qr</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">seatIds</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">BookingStatus</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="n">BookingStatus</span><span class="p">.</span><span class="na">CONFIRMED</span><span class="p">;</span>
<span class="w">    </span><span class="n">Booking</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">showId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">seatIds</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">qr</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">showId</span><span class="o">=</span><span class="n">showId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">userId</span><span class="o">=</span><span class="n">userId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">seatIds</span><span class="o">=</span><span class="n">seatIds</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">qr</span><span class="o">=</span><span class="n">qr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Payment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">bookingId</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">txnRef</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="n">PaymentStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">paidAt</span><span class="p">;</span>
<span class="w">    </span><span class="n">Payment</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">bookingId</span><span class="o">=</span><span class="n">b</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">method</span><span class="o">=</span><span class="n">m</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">txnRef</span><span class="o">=</span><span class="n">x</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">amount</span><span class="o">=</span><span class="n">a</span><span class="p">;}</span>
<span class="p">}</span>

<span class="cm">/* ===== Repos (in-memory) ===== */</span>
<span class="kd">class</span> <span class="nc">Ids</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">n</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>

<span class="kd">class</span> <span class="nc">MoviesRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Movie</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Movie</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Movie</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Movie</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">TheatersRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Theater</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Theater</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Theater</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Theater</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">ScreensRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Screen</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Screen</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Screen</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Screen</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">SeatsRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Seat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Seat</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Seat</span><span class="w"> </span><span class="n">s</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">s</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Seat</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byScreen</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">screenId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="na">screenId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">screenId</span><span class="p">)).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Seat</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">ShowsRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Show</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Show</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Show</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Show</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Show</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">all</span><span class="p">(){</span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">());}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">HoldsRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">SeatHold</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">SeatHold</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">SeatHold</span><span class="w"> </span><span class="n">h</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">h</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">h</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SeatHold</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SeatHold</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">activeByShow</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">showId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Instant</span><span class="w"> </span><span class="n">now</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="na">showId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">showId</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">h</span><span class="p">.</span><span class="na">active</span><span class="o">&amp;&amp;</span><span class="n">h</span><span class="p">.</span><span class="na">expiresAt</span><span class="p">.</span><span class="na">isAfter</span><span class="p">(</span><span class="n">now</span><span class="p">)).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">BookingsRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Booking</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Booking</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Booking</span><span class="w"> </span><span class="n">b</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">b</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">b</span><span class="p">;}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Booking</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byShow</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">showId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="na">showId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">showId</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">b</span><span class="p">.</span><span class="na">status</span><span class="o">==</span><span class="n">BookingStatus</span><span class="p">.</span><span class="na">CONFIRMED</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">PaymentsRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Payment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Payment</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Payment</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">p</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byBooking</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">bookingId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="na">bookingId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">bookingId</span><span class="p">)).</span><span class="na">findFirst</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Errors ===== */</span>
<span class="kd">class</span> <span class="nc">DomainException</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">RuntimeException</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">m</span><span class="p">){</span><span class="kd">super</span><span class="p">(</span><span class="n">m</span><span class="p">);}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Services ===== */</span>
<span class="kd">class</span> <span class="nc">ShowSearchService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ShowsRepo</span><span class="w"> </span><span class="n">shows</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TheatersRepo</span><span class="w"> </span><span class="n">theaters</span><span class="p">;</span>
<span class="w">    </span><span class="n">ShowSearchService</span><span class="p">(</span><span class="n">ShowsRepo</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">TheatersRepo</span><span class="w"> </span><span class="n">t</span><span class="p">){</span><span class="n">shows</span><span class="o">=</span><span class="n">s</span><span class="p">;</span><span class="n">theaters</span><span class="o">=</span><span class="n">t</span><span class="p">;}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Show</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">movieId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">date</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shows</span><span class="p">.</span><span class="na">all</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">.</span><span class="na">movieId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">movieId</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">theaters</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">sh</span><span class="p">.</span><span class="na">screenId</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">th</span><span class="p">.</span><span class="na">city</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">city</span><span class="p">)).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">.</span><span class="na">startAt</span><span class="p">.</span><span class="na">toLocalDate</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">date</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">PerShowLocks</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ReentrantLock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">locks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">ReentrantLock</span><span class="w"> </span><span class="nf">lockFor</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">showId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">locks</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">showId</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">ReentrantLock</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">SeatInventoryService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ShowsRepo</span><span class="w"> </span><span class="n">shows</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ScreensRepo</span><span class="w"> </span><span class="n">screens</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SeatsRepo</span><span class="w"> </span><span class="n">seats</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">HoldsRepo</span><span class="w"> </span><span class="n">holds</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BookingsRepo</span><span class="w"> </span><span class="n">bookings</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PerShowLocks</span><span class="w"> </span><span class="n">locks</span><span class="p">;</span>

<span class="w">    </span><span class="n">SeatInventoryService</span><span class="p">(</span><span class="n">ShowsRepo</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="n">ScreensRepo</span><span class="w"> </span><span class="n">sc</span><span class="p">,</span><span class="n">SeatsRepo</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="n">HoldsRepo</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="n">BookingsRepo</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="n">PerShowLocks</span><span class="w"> </span><span class="n">L</span><span class="p">){</span>
<span class="w">        </span><span class="n">shows</span><span class="o">=</span><span class="n">sh</span><span class="p">;</span><span class="w"> </span><span class="n">screens</span><span class="o">=</span><span class="n">sc</span><span class="p">;</span><span class="w"> </span><span class="n">seats</span><span class="o">=</span><span class="n">se</span><span class="p">;</span><span class="w"> </span><span class="n">holds</span><span class="o">=</span><span class="n">h</span><span class="p">;</span><span class="w"> </span><span class="n">bookings</span><span class="o">=</span><span class="n">b</span><span class="p">;</span><span class="w"> </span><span class="n">locks</span><span class="o">=</span><span class="n">L</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SeatView</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">seatId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SeatType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">        </span><span class="n">SeatView</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="n">SeatType</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">){</span><span class="n">seatId</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="n">row</span><span class="o">=</span><span class="n">r</span><span class="p">;</span><span class="n">col</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="n">type</span><span class="o">=</span><span class="n">t</span><span class="p">;</span><span class="n">status</span><span class="o">=</span><span class="n">s</span><span class="p">;}</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">toString</span><span class="p">(){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">seatId</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">status</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SeatView</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">seatMap</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">showId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Show</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shows</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">showId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;show not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Screen</span><span class="w"> </span><span class="n">screen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screens</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">show</span><span class="p">.</span><span class="na">screenId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;screen not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Seat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allSeats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seats</span><span class="p">.</span><span class="na">byScreen</span><span class="p">(</span><span class="n">screen</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">booked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bookings</span><span class="p">.</span><span class="na">byShow</span><span class="p">(</span><span class="n">showId</span><span class="p">).</span><span class="na">stream</span><span class="p">().</span><span class="na">flatMap</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="na">seatIds</span><span class="p">.</span><span class="na">stream</span><span class="p">()).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toSet</span><span class="p">());</span>
<span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">held</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">holds</span><span class="p">.</span><span class="na">activeByShow</span><span class="p">(</span><span class="n">showId</span><span class="p">).</span><span class="na">stream</span><span class="p">().</span><span class="na">flatMap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="na">seatIds</span><span class="p">.</span><span class="na">stream</span><span class="p">()).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toSet</span><span class="p">());</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SeatView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Seat</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">allSeats</span><span class="p">){</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">booked</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">id</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;BOOKED&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">held</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">id</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;HELD&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;FREE&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SeatView</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">row</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">col</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">type</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">sort</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparingInt</span><span class="p">((</span><span class="n">SeatView</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="na">row</span><span class="p">).</span><span class="na">thenComparingInt</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="na">col</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">SeatHold</span><span class="w"> </span><span class="nf">holdSeats</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">showId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">seatIds</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">ttl</span><span class="p">){</span>
<span class="w">        </span><span class="n">ReentrantLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locks</span><span class="p">.</span><span class="na">lockFor</span><span class="p">(</span><span class="n">showId</span><span class="p">);</span>
<span class="w">        </span><span class="n">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span>
<span class="w">        </span><span class="k">try</span><span class="p">{</span>
<span class="w">            </span><span class="c1">// filter out expired automatically (holds.activeByShow uses time)</span>
<span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">booked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bookings</span><span class="p">.</span><span class="na">byShow</span><span class="p">(</span><span class="n">showId</span><span class="p">).</span><span class="na">stream</span><span class="p">().</span><span class="na">flatMap</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="na">seatIds</span><span class="p">.</span><span class="na">stream</span><span class="p">()).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toSet</span><span class="p">());</span>
<span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">held</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">holds</span><span class="p">.</span><span class="na">activeByShow</span><span class="p">(</span><span class="n">showId</span><span class="p">).</span><span class="na">stream</span><span class="p">().</span><span class="na">flatMap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="na">seatIds</span><span class="p">.</span><span class="na">stream</span><span class="p">()).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toSet</span><span class="p">());</span>

<span class="w">            </span><span class="c1">// validate requested seats exist &amp; are free</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">seatId</span><span class="p">:</span><span class="w"> </span><span class="n">seatIds</span><span class="p">){</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">booked</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">seatId</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">held</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">seatId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;seat not available: &quot;</span><span class="o">+</span><span class="n">seatId</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">SeatHold</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SeatHold</span><span class="p">(</span><span class="n">BookMyShow40Min</span><span class="p">.</span><span class="na">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;hold&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">showId</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">seatIds</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">plus</span><span class="p">(</span><span class="n">ttl</span><span class="p">));</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">holds</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">BookingService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ShowsRepo</span><span class="w"> </span><span class="n">shows</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">HoldsRepo</span><span class="w"> </span><span class="n">holds</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BookingsRepo</span><span class="w"> </span><span class="n">bookings</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PaymentsRepo</span><span class="w"> </span><span class="n">payments</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PerShowLocks</span><span class="w"> </span><span class="n">locks</span><span class="p">;</span>

<span class="w">    </span><span class="n">BookingService</span><span class="p">(</span><span class="n">ShowsRepo</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="n">HoldsRepo</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="n">BookingsRepo</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="n">PaymentsRepo</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="n">PerShowLocks</span><span class="w"> </span><span class="n">L</span><span class="p">){</span>
<span class="w">        </span><span class="n">shows</span><span class="o">=</span><span class="n">sh</span><span class="p">;</span><span class="w"> </span><span class="n">holds</span><span class="o">=</span><span class="n">h</span><span class="p">;</span><span class="w"> </span><span class="n">bookings</span><span class="o">=</span><span class="n">b</span><span class="p">;</span><span class="w"> </span><span class="n">payments</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="n">locks</span><span class="o">=</span><span class="n">L</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Booking</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">holdId</span><span class="p">){</span>
<span class="w">        </span><span class="n">SeatHold</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">holds</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">holdId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;hold not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">.</span><span class="na">active</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="na">expiresAt</span><span class="p">.</span><span class="na">isBefore</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">()))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;hold expired&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">ReentrantLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locks</span><span class="p">.</span><span class="na">lockFor</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="na">showId</span><span class="p">);</span>
<span class="w">        </span><span class="n">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span>
<span class="w">        </span><span class="k">try</span><span class="p">{</span>
<span class="w">            </span><span class="c1">// re-check availability under lock</span>
<span class="w">            </span><span class="c1">// (if any seat is already booked meanwhile, fail)</span>
<span class="w">            </span><span class="c1">// Collect currently booked seats for the show:</span>
<span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">booked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bookings</span><span class="p">.</span><span class="na">byShow</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="na">showId</span><span class="p">).</span><span class="na">stream</span><span class="p">().</span><span class="na">flatMap</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="na">seatIds</span><span class="p">.</span><span class="na">stream</span><span class="p">()).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toSet</span><span class="p">());</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="na">seatIds</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">booked</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;seat got booked: &quot;</span><span class="o">+</span><span class="n">s</span><span class="p">);</span>

<span class="w">            </span><span class="n">Show</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shows</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="na">showId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;show not found&quot;</span><span class="p">));</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">show</span><span class="p">.</span><span class="na">basePrice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="na">seatIds</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">qr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
<span class="w">            </span><span class="n">Booking</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Booking</span><span class="p">(</span><span class="n">BookMyShow40Min</span><span class="p">.</span><span class="na">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;bkg&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="na">showId</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="na">seatIds</span><span class="p">),</span><span class="w"> </span><span class="n">round2</span><span class="p">(</span><span class="n">price</span><span class="p">),</span><span class="w"> </span><span class="n">qr</span><span class="p">);</span>
<span class="w">            </span><span class="n">h</span><span class="p">.</span><span class="na">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// consume hold</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">bookings</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">round2</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">v</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">PaymentService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PaymentsRepo</span><span class="w"> </span><span class="n">payments</span><span class="p">;</span>
<span class="w">    </span><span class="n">PaymentService</span><span class="p">(</span><span class="n">PaymentsRepo</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="n">payments</span><span class="o">=</span><span class="n">p</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Payment</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">bookingId</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">txnRef</span><span class="p">){</span>
<span class="w">        </span><span class="n">Payment</span><span class="w"> </span><span class="n">pay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Payment</span><span class="p">(</span><span class="n">BookMyShow40Min</span><span class="p">.</span><span class="na">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;pay&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">bookingId</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">txnRef</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">);</span>
<span class="w">        </span><span class="n">pay</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="p">.</span><span class="na">PAID</span><span class="p">;</span><span class="w"> </span><span class="n">pay</span><span class="p">.</span><span class="na">paidAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span><span class="w"> </span><span class="c1">// simulate success</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payments</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">pay</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Controller Facade (mirrors the APIs) ===== */</span>
<span class="kd">class</span> <span class="nc">BookingController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ShowSearchService</span><span class="w"> </span><span class="n">search</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SeatInventoryService</span><span class="w"> </span><span class="n">inv</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BookingService</span><span class="w"> </span><span class="n">bookings</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PaymentService</span><span class="w"> </span><span class="n">payments</span><span class="p">;</span>

<span class="w">    </span><span class="n">BookingController</span><span class="p">(</span><span class="n">ShowSearchService</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">SeatInventoryService</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">BookingService</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">PaymentService</span><span class="w"> </span><span class="n">p</span><span class="p">){</span>
<span class="w">        </span><span class="n">search</span><span class="o">=</span><span class="n">s</span><span class="p">;</span><span class="w"> </span><span class="n">inv</span><span class="o">=</span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">bookings</span><span class="o">=</span><span class="n">b</span><span class="p">;</span><span class="w"> </span><span class="n">payments</span><span class="o">=</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Show</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getShows</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">movieId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">date</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">search</span><span class="p">.</span><span class="na">list</span><span class="p">(</span><span class="n">movieId</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SeatInventoryService</span><span class="p">.</span><span class="na">SeatView</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getSeatMap</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">showId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="na">seatMap</span><span class="p">(</span><span class="n">showId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">SeatHold</span><span class="w"> </span><span class="nf">postHold</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">showId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">seatIds</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ttlSec</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="na">holdSeats</span><span class="p">(</span><span class="n">showId</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">seatIds</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="n">ttlSec</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Booking</span><span class="w"> </span><span class="nf">postBooking</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">holdId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">bookings</span><span class="p">.</span><span class="na">confirm</span><span class="p">(</span><span class="n">holdId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">Payment</span><span class="w"> </span><span class="nf">postPayment</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">bookingId</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">txnRef</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payments</span><span class="p">.</span><span class="na">confirm</span><span class="p">(</span><span class="n">bookingId</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">txnRef</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Bootstrap &amp; Demo (tiny, 40-min compatible) ===== */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BookMyShow40Min</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ids</span><span class="p">();</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Repos</span>
<span class="w">        </span><span class="n">MoviesRepo</span><span class="w"> </span><span class="n">movies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MoviesRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">TheatersRepo</span><span class="w"> </span><span class="n">theaters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TheatersRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">ScreensRepo</span><span class="w"> </span><span class="n">screens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ScreensRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">SeatsRepo</span><span class="w"> </span><span class="n">seats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SeatsRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">ShowsRepo</span><span class="w"> </span><span class="n">shows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ShowsRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">HoldsRepo</span><span class="w"> </span><span class="n">holds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HoldsRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">BookingsRepo</span><span class="w"> </span><span class="n">bookings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BookingsRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">PaymentsRepo</span><span class="w"> </span><span class="n">payments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaymentsRepo</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Seed</span>
<span class="w">        </span><span class="n">Movie</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">movies</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Movie</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;mov&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Interstellar&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">169</span><span class="p">));</span>
<span class="w">        </span><span class="n">Theater</span><span class="w"> </span><span class="n">th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">theaters</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Theater</span><span class="p">(</span><span class="s">&quot;TH-1:SCR-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bengaluru&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Galaxy Cinema&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Screen</span><span class="w"> </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screens</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Screen</span><span class="p">(</span><span class="s">&quot;SCR-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">th</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Screen 1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span><span class="w"> </span><span class="c1">// small 3x4 for demo</span>
<span class="w">        </span><span class="c1">// Seats</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">sc</span><span class="p">.</span><span class="na">rows</span><span class="p">;</span><span class="n">r</span><span class="o">++</span><span class="p">){</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">c</span><span class="o">&lt;=</span><span class="n">sc</span><span class="p">.</span><span class="na">cols</span><span class="p">;</span><span class="n">c</span><span class="o">++</span><span class="p">){</span>
<span class="w">                </span><span class="n">SeatType</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="mi">1</span><span class="o">?</span><span class="n">SeatType</span><span class="p">.</span><span class="na">PREMIUM</span><span class="p">:</span><span class="n">SeatType</span><span class="p">.</span><span class="na">REGULAR</span><span class="p">);</span>
<span class="w">                </span><span class="n">seats</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Seat</span><span class="p">(</span><span class="s">&quot;SEAT-&quot;</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Show (note: we embed theater id in Show.screenId owner link for city mapping shortcut)</span>
<span class="w">        </span><span class="n">ZonedDateTime</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZonedDateTime</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">LocalDate</span><span class="p">.</span><span class="na">now</span><span class="p">(),</span><span class="w"> </span><span class="n">LocalTime</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">ZoneId</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;Asia/Kolkata&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Show</span><span class="w"> </span><span class="n">sh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shows</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Show</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;show&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="mf">250.0</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Services</span>
<span class="w">        </span><span class="n">PerShowLocks</span><span class="w"> </span><span class="n">locks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PerShowLocks</span><span class="p">();</span>
<span class="w">        </span><span class="n">ShowSearchService</span><span class="w"> </span><span class="n">search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ShowSearchService</span><span class="p">(</span><span class="n">shows</span><span class="p">,</span><span class="w"> </span><span class="n">theaters</span><span class="p">);</span>
<span class="w">        </span><span class="n">SeatInventoryService</span><span class="w"> </span><span class="n">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SeatInventoryService</span><span class="p">(</span><span class="n">shows</span><span class="p">,</span><span class="w"> </span><span class="n">screens</span><span class="p">,</span><span class="w"> </span><span class="n">seats</span><span class="p">,</span><span class="w"> </span><span class="n">holds</span><span class="p">,</span><span class="w"> </span><span class="n">bookings</span><span class="p">,</span><span class="w"> </span><span class="n">locks</span><span class="p">);</span>
<span class="w">        </span><span class="n">BookingService</span><span class="w"> </span><span class="n">bookingSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BookingService</span><span class="p">(</span><span class="n">shows</span><span class="p">,</span><span class="w"> </span><span class="n">holds</span><span class="p">,</span><span class="w"> </span><span class="n">bookings</span><span class="p">,</span><span class="w"> </span><span class="n">payments</span><span class="p">,</span><span class="w"> </span><span class="n">locks</span><span class="p">);</span>
<span class="w">        </span><span class="n">PaymentService</span><span class="w"> </span><span class="n">paymentSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaymentService</span><span class="p">(</span><span class="n">payments</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Controller</span>
<span class="w">        </span><span class="n">BookingController</span><span class="w"> </span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BookingController</span><span class="p">(</span><span class="n">search</span><span class="p">,</span><span class="w"> </span><span class="n">inventory</span><span class="p">,</span><span class="w"> </span><span class="n">bookingSvc</span><span class="p">,</span><span class="w"> </span><span class="n">paymentSvc</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// --- Demo flow (as API calls) ---</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;GET /movies/{movieId}/shows?city=Bengaluru&amp;date=today&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">api</span><span class="p">.</span><span class="na">getShows</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bengaluru&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDate</span><span class="p">.</span><span class="na">now</span><span class="p">()));</span>

<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nGET /shows/{showId}/seats&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">api</span><span class="p">.</span><span class="na">getSeatMap</span><span class="p">(</span><span class="n">sh</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>

<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nPOST /shows/{showId}/hold  seats=[SEAT-1-1, SEAT-1-2]&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">SeatHold</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postHold</span><span class="p">(</span><span class="n">sh</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user-42&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">setOf</span><span class="p">(</span><span class="s">&quot;SEAT-1-1&quot;</span><span class="p">,</span><span class="s">&quot;SEAT-1-2&quot;</span><span class="p">),</span><span class="w"> </span><span class="mi">300</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hold: &quot;</span><span class="o">+</span><span class="n">hold</span><span class="p">.</span><span class="na">id</span><span class="o">+</span><span class="s">&quot; expiresAt=&quot;</span><span class="o">+</span><span class="n">hold</span><span class="p">.</span><span class="na">expiresAt</span><span class="p">);</span>

<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nGET /shows/{showId}/seats  (after hold)&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">api</span><span class="p">.</span><span class="na">getSeatMap</span><span class="p">(</span><span class="n">sh</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>

<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nPOST /bookings  {holdId}&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Booking</span><span class="w"> </span><span class="n">booking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postBooking</span><span class="p">(</span><span class="n">hold</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Booking: &quot;</span><span class="o">+</span><span class="n">booking</span><span class="p">.</span><span class="na">id</span><span class="o">+</span><span class="s">&quot; seats=&quot;</span><span class="o">+</span><span class="n">booking</span><span class="p">.</span><span class="na">seatIds</span><span class="o">+</span><span class="s">&quot; amount=&quot;</span><span class="o">+</span><span class="n">booking</span><span class="p">.</span><span class="na">amount</span><span class="o">+</span><span class="s">&quot; qr=&quot;</span><span class="o">+</span><span class="n">booking</span><span class="p">.</span><span class="na">qr</span><span class="p">);</span>

<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nPOST /payments/confirm&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Payment</span><span class="w"> </span><span class="n">pay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postPayment</span><span class="p">(</span><span class="n">booking</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">booking</span><span class="p">.</span><span class="na">amount</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UPI&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TXN-123&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Payment: &quot;</span><span class="o">+</span><span class="n">pay</span><span class="p">.</span><span class="na">id</span><span class="o">+</span><span class="s">&quot; status=&quot;</span><span class="o">+</span><span class="n">pay</span><span class="p">.</span><span class="na">status</span><span class="o">+</span><span class="s">&quot; paidAt=&quot;</span><span class="o">+</span><span class="n">pay</span><span class="p">.</span><span class="na">paidAt</span><span class="p">);</span>

<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nGET /shows/{showId}/seats  (after booking)&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">api</span><span class="p">.</span><span class="na">getSeatMap</span><span class="p">(</span><span class="n">sh</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">setOf</span><span class="p">(</span><span class="n">String</span><span class="p">...</span><span class="na">xs</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">xs</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="food-delivery">Food Delivery<a class="headerlink" href="#food-delivery" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>/*
Template -&gt;
1) define functional requirements
   - Browse restaurants by area/cuisine; view menu items (veg/non-veg).
   - Create cart per user per restaurant; add/remove items; compute totals, taxes, delivery fee.
   - Place order (from a single restaurant), capture address &amp; instructions.
   - Payment confirmation (stub) → move order to PLACED/PAID.
   - Assign nearest available delivery partner; update order status (PREPARING → PICKED_UP → DELIVERED).
   - Track order with ETA; list user&#39;s past orders.
   - In-memory implementation; single city; thread-safe where needed; deliverable in ~40 min.

2) define entities / actors
   Actors: Customer, Restaurant, DeliveryPartner, System/PaymentGateway (stub)
   Entities: Restaurant, MenuItem, Cart, CartItem, Order, OrderItem, Payment, DeliveryPartner, GeoPoint

3) define apis - get/post/put, request, response  (mirrored by controller methods)
   GET  /restaurants?area=HSR&amp;cuisine=NorthIndian     -&gt; [restaurant...]
   GET  /restaurants/{id}/menu                        -&gt; [menuItem...]
   POST /cart/items                                   {userId, restaurantId, itemId, qty} -&gt; cart view
   DELETE /cart/items                                 {userId, itemId} -&gt; cart view
   POST /orders                                       {userId, address, instructions?} -&gt; {orderId, amount}
   POST /payments/confirm                             {orderId, method, txnRef?} -&gt; {paymentId, status}
   POST /orders/{orderId}/assign                      -&gt; {partnerId, etaMin}
   GET  /orders/{orderId}/track                       -&gt; {status, etaMin, partnerLoc?}

4) define services involved
   CatalogService        - search restaurants, menu retrieval
   CartService           - add/remove, compute totals
   PricingService        - taxes (e.g., 5%), delivery fee (distance slab), surge hooks
   OrderService          - place &amp; manage order lifecycle
   PaymentService        - confirm payments (stub)
   AssignmentService     - choose nearest available delivery partner
   TrackingService       - ETA calc &amp; status updates
   IdGenerator           - ID generation

5) define db schema - what all tables are required, what are the columns, what are the keys
   restaurant(id PK, name, area, cuisines JSON, lat, lon, rating)
   menu_item(id PK, restaurant_id FK, name, price, veg BOOL, in_stock BOOL)
   cart(id PK, user_id, restaurant_id, updated_at)
   cart_item(id PK, cart_id FK, item_id FK, qty)
   order(id PK, user_id, restaurant_id, address, instructions, status, sub_total, tax, delivery_fee, total, created_at)
   order_item(id PK, order_id FK, item_id FK, name_snapshot, price_snapshot, qty)
   payment(id PK, order_id FK UNIQUE, method, amount, txn_ref, status, paid_at)
   delivery_partner(id PK, name, lat, lon, available BOOL, rating)
*/
</code></pre></div>
<h3 id="java-implementation_2">Java Implementation<a class="headerlink" href="#java-implementation_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">Template -&gt;</span>
<span class="cm">1) define functional requirements</span>
<span class="cm">   - Browse restaurants by area/cuisine; view menu items (veg/non-veg).</span>
<span class="cm">   - Create cart per user per restaurant; add/remove items; compute totals, taxes, delivery fee.</span>
<span class="cm">   - Place order (from a single restaurant), capture address &amp; instructions.</span>
<span class="cm">   - Payment confirmation (stub) → move order to PLACED/PAID.</span>
<span class="cm">   - Assign nearest available delivery partner; update order status (PREPARING → PICKED_UP → DELIVERED).</span>
<span class="cm">   - Track order with ETA; list user&#39;s past orders.</span>
<span class="cm">   - In-memory implementation; single city; thread-safe where needed; deliverable in ~40 min.</span>

<span class="cm">2) define entities / actors</span>
<span class="cm">   Actors: Customer, Restaurant, DeliveryPartner, System/PaymentGateway (stub)</span>
<span class="cm">   Entities: Restaurant, MenuItem, Cart, CartItem, Order, OrderItem, Payment, DeliveryPartner, GeoPoint</span>

<span class="cm">3) define apis - get/post/put, request, response  (mirrored by controller methods)</span>
<span class="cm">   GET  /restaurants?area=HSR&amp;cuisine=NorthIndian     -&gt; [restaurant...]</span>
<span class="cm">   GET  /restaurants/{id}/menu                        -&gt; [menuItem...]</span>
<span class="cm">   POST /cart/items                                   {userId, restaurantId, itemId, qty} -&gt; cart view</span>
<span class="cm">   DELETE /cart/items                                 {userId, itemId} -&gt; cart view</span>
<span class="cm">   POST /orders                                       {userId, address, instructions?} -&gt; {orderId, amount}</span>
<span class="cm">   POST /payments/confirm                             {orderId, method, txnRef?} -&gt; {paymentId, status}</span>
<span class="cm">   POST /orders/{orderId}/assign                      -&gt; {partnerId, etaMin}</span>
<span class="cm">   GET  /orders/{orderId}/track                       -&gt; {status, etaMin, partnerLoc?}</span>

<span class="cm">4) define services involved</span>
<span class="cm">   CatalogService        - search restaurants, menu retrieval</span>
<span class="cm">   CartService           - add/remove, compute totals</span>
<span class="cm">   PricingService        - taxes (e.g., 5%), delivery fee (distance slab), surge hooks</span>
<span class="cm">   OrderService          - place &amp; manage order lifecycle</span>
<span class="cm">   PaymentService        - confirm payments (stub)</span>
<span class="cm">   AssignmentService     - choose nearest available delivery partner</span>
<span class="cm">   TrackingService       - ETA calc &amp; status updates</span>
<span class="cm">   IdGenerator           - ID generation</span>

<span class="cm">5) define db schema - what all tables are required, what are the columns, what are the keys</span>
<span class="cm">   restaurant(id PK, name, area, cuisines JSON, lat, lon, rating)</span>
<span class="cm">   menu_item(id PK, restaurant_id FK, name, price, veg BOOL, in_stock BOOL)</span>
<span class="cm">   cart(id PK, user_id, restaurant_id, updated_at)</span>
<span class="cm">   cart_item(id PK, cart_id FK, item_id FK, qty)</span>
<span class="cm">   order(id PK, user_id, restaurant_id, address, instructions, status, sub_total, tax, delivery_fee, total, created_at)</span>
<span class="cm">   order_item(id PK, order_id FK, item_id FK, name_snapshot, price_snapshot, qty)</span>
<span class="cm">   payment(id PK, order_id FK UNIQUE, method, amount, txn_ref, status, paid_at)</span>
<span class="cm">   delivery_partner(id PK, name, lat, lon, available BOOL, rating)</span>
<span class="cm">*/</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="cm">/* ===== Domain ===== */</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">OrderStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">CART</span><span class="p">,</span><span class="w"> </span><span class="n">PLACED</span><span class="p">,</span><span class="w"> </span><span class="n">PAID</span><span class="p">,</span><span class="w"> </span><span class="n">PREPARING</span><span class="p">,</span><span class="w"> </span><span class="n">PICKED_UP</span><span class="p">,</span><span class="w"> </span><span class="n">DELIVERED</span><span class="p">,</span><span class="w"> </span><span class="n">CANCELLED</span><span class="w"> </span><span class="p">}</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">PENDING</span><span class="p">,</span><span class="w"> </span><span class="n">PAID</span><span class="p">,</span><span class="w"> </span><span class="n">FAILED</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GeoPoint</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="p">;</span><span class="w"> </span><span class="n">GeoPoint</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">lon</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Restaurant</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cuisines</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">GeoPoint</span><span class="w"> </span><span class="n">loc</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">rating</span><span class="p">;</span>
<span class="w">    </span><span class="n">Restaurant</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cuisines</span><span class="p">,</span><span class="n">GeoPoint</span><span class="w"> </span><span class="n">loc</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">rating</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">area</span><span class="o">=</span><span class="n">area</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">cuisines</span><span class="o">=</span><span class="n">cuisines</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">rating</span><span class="o">=</span><span class="n">rating</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MenuItem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">veg</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">inStock</span><span class="p">;</span>
<span class="w">    </span><span class="n">MenuItem</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">rid</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="p">,</span><span class="kt">boolean</span><span class="w"> </span><span class="n">veg</span><span class="p">,</span><span class="kt">boolean</span><span class="w"> </span><span class="n">inStock</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">restaurantId</span><span class="o">=</span><span class="n">rid</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">price</span><span class="o">=</span><span class="n">price</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">veg</span><span class="o">=</span><span class="n">veg</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">inStock</span><span class="o">=</span><span class="n">inStock</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CartItem</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">itemId</span><span class="p">;</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">qty</span><span class="p">;</span><span class="w"> </span><span class="n">CartItem</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">itemId</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">qty</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">itemId</span><span class="o">=</span><span class="n">itemId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Cart</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">CartItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="n">Cart</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">userId</span><span class="o">=</span><span class="n">userId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">restaurantId</span><span class="o">=</span><span class="n">restaurantId</span><span class="p">;}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderItem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">itemId</span><span class="p">,</span><span class="w"> </span><span class="n">nameSnapshot</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">priceSnapshot</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">qty</span><span class="p">;</span>
<span class="w">    </span><span class="n">OrderItem</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">itemId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">qty</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">itemId</span><span class="o">=</span><span class="n">itemId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">nameSnapshot</span><span class="o">=</span><span class="n">name</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">priceSnapshot</span><span class="o">=</span><span class="n">price</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">;}</span>
<span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Order</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">instructions</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">OrderStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">PLACED</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">subTotal</span><span class="p">,</span><span class="w"> </span><span class="n">tax</span><span class="p">,</span><span class="w"> </span><span class="n">deliveryFee</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">partnerId</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">etaMin</span><span class="p">;</span>
<span class="w">    </span><span class="n">Order</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">instr</span><span class="p">,</span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="p">,</span>
<span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">sub</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">tax</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">del</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">tot</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">userId</span><span class="o">=</span><span class="n">userId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">restaurantId</span><span class="o">=</span><span class="n">restaurantId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">address</span><span class="o">=</span><span class="n">address</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">instructions</span><span class="o">=</span><span class="n">instr</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">items</span><span class="o">=</span><span class="n">items</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">subTotal</span><span class="o">=</span><span class="n">sub</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">tax</span><span class="o">=</span><span class="n">tax</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">deliveryFee</span><span class="o">=</span><span class="n">del</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">total</span><span class="o">=</span><span class="n">tot</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Payment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">txnRef</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">paidAt</span><span class="p">;</span>
<span class="w">    </span><span class="n">Payment</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">txnRef</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">orderId</span><span class="o">=</span><span class="n">orderId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">method</span><span class="o">=</span><span class="n">method</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">txnRef</span><span class="o">=</span><span class="n">txnRef</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DeliveryPartner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">GeoPoint</span><span class="w"> </span><span class="n">loc</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">available</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">rating</span><span class="p">;</span>
<span class="w">    </span><span class="n">DeliveryPartner</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">GeoPoint</span><span class="w"> </span><span class="n">loc</span><span class="p">,</span><span class="kt">boolean</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">rating</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">available</span><span class="o">=</span><span class="n">available</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">rating</span><span class="o">=</span><span class="n">rating</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Repos (in-memory) ===== */</span>
<span class="kd">class</span> <span class="nc">Ids</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">n</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">();}</span><span class="w"> </span><span class="p">}</span>

<span class="kd">class</span> <span class="nc">RestaurantRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Restaurant</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Restaurant</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Restaurant</span><span class="w"> </span><span class="n">r</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">r</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Restaurant</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">cuisine</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">area</span><span class="o">==</span><span class="kc">null</span><span class="o">||</span><span class="n">r</span><span class="p">.</span><span class="na">area</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">area</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">cuisine</span><span class="o">==</span><span class="kc">null</span><span class="o">||</span><span class="n">r</span><span class="p">.</span><span class="na">cuisines</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">anyMatch</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">cuisine</span><span class="p">)))</span>
<span class="w">                </span><span class="p">.</span><span class="na">sorted</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparingDouble</span><span class="p">((</span><span class="n">Restaurant</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="o">-&gt;-</span><span class="n">r</span><span class="p">.</span><span class="na">rating</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Restaurant</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">MenuRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">MenuItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">MenuItem</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">MenuItem</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">MenuItem</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byRestaurant</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rid</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="na">restaurantId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">rid</span><span class="p">)).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">MenuItem</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">CartRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Cart</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">// key: userId</span>
<span class="w">    </span><span class="n">Cart</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Cart</span><span class="w"> </span><span class="n">c</span><span class="p">){</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">userId</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">OrderRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Order</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Order</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Order</span><span class="w"> </span><span class="n">o</span><span class="p">){</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">o</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">o</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">o</span><span class="p">.</span><span class="na">userId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">user</span><span class="p">)).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">PaymentRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Payment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Payment</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Payment</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">p</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byOrder</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="na">orderId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">orderId</span><span class="p">)).</span><span class="na">findFirst</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">PartnerRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">DeliveryPartner</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">DeliveryPartner</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">DeliveryPartner</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">p</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DeliveryPartner</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">available</span><span class="p">(){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="na">available</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">DeliveryPartner</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Utils ===== */</span>
<span class="kd">class</span> <span class="nc">Haversine</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">distanceKm</span><span class="p">(</span><span class="n">GeoPoint</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">GeoPoint</span><span class="w"> </span><span class="n">b</span><span class="p">){</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">R</span><span class="o">=</span><span class="mf">6371.0</span><span class="p">,</span><span class="w"> </span><span class="n">dLat</span><span class="o">=</span><span class="n">Math</span><span class="p">.</span><span class="na">toRadians</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">lat</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="na">lat</span><span class="p">),</span><span class="w"> </span><span class="n">dLon</span><span class="o">=</span><span class="n">Math</span><span class="p">.</span><span class="na">toRadians</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">lon</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="na">lon</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">s1</span><span class="o">=</span><span class="n">Math</span><span class="p">.</span><span class="na">sin</span><span class="p">(</span><span class="n">dLat</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">s2</span><span class="o">=</span><span class="n">Math</span><span class="p">.</span><span class="na">sin</span><span class="p">(</span><span class="n">dLon</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">aa</span><span class="o">=</span><span class="n">s1</span><span class="o">*</span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">cos</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">toRadians</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">lat</span><span class="p">))</span><span class="o">*</span><span class="n">Math</span><span class="p">.</span><span class="na">cos</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">toRadians</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">lat</span><span class="p">))</span><span class="o">*</span><span class="n">s2</span><span class="o">*</span><span class="n">s2</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">R</span><span class="o">*</span><span class="n">Math</span><span class="p">.</span><span class="na">asin</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">sqrt</span><span class="p">(</span><span class="n">aa</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">etaMin</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">km</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="n">km</span><span class="o">/</span><span class="mf">0.35</span><span class="p">));</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// ~21 km/h avg</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">DomainException</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">RuntimeException</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">m</span><span class="p">){</span><span class="kd">super</span><span class="p">(</span><span class="n">m</span><span class="p">);}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Services ===== */</span>
<span class="kd">class</span> <span class="nc">CatalogService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RestaurantRepo</span><span class="w"> </span><span class="n">restaurants</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MenuRepo</span><span class="w"> </span><span class="n">menu</span><span class="p">;</span>
<span class="w">    </span><span class="n">CatalogService</span><span class="p">(</span><span class="n">RestaurantRepo</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">MenuRepo</span><span class="w"> </span><span class="n">m</span><span class="p">){</span><span class="n">restaurants</span><span class="o">=</span><span class="n">r</span><span class="p">;</span><span class="w"> </span><span class="n">menu</span><span class="o">=</span><span class="n">m</span><span class="p">;}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Restaurant</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">cuisine</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">restaurants</span><span class="p">.</span><span class="na">search</span><span class="p">(</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">cuisine</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">MenuItem</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">menu</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">menu</span><span class="p">.</span><span class="na">byRestaurant</span><span class="p">(</span><span class="n">restaurantId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">PricingService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">taxRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5%</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="nf">subTotal</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">round2</span><span class="p">(</span><span class="n">items</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">mapToDouble</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="na">priceSnapshot</span><span class="o">*</span><span class="n">i</span><span class="p">.</span><span class="na">qty</span><span class="p">).</span><span class="na">sum</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="nf">tax</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sub</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">round2</span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">taxRate</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="nf">deliveryFee</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">distanceKm</span><span class="p">){</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">fee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distanceKm</span><span class="o">&lt;=</span><span class="mi">2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">distanceKm</span><span class="o">&lt;=</span><span class="mi">5</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">35</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">distanceKm</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">round2</span><span class="p">(</span><span class="n">fee</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="nf">total</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sub</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">tax</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">del</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">round2</span><span class="p">(</span><span class="n">sub</span><span class="o">+</span><span class="n">tax</span><span class="o">+</span><span class="n">del</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">round2</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">v</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">CartService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CartRepo</span><span class="w"> </span><span class="n">carts</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MenuRepo</span><span class="w"> </span><span class="n">menu</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">CartService</span><span class="p">(</span><span class="n">CartRepo</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">MenuRepo</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">carts</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="n">menu</span><span class="o">=</span><span class="n">m</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Cart</span><span class="w"> </span><span class="nf">addItem</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">itemId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">qty</span><span class="p">){</span>
<span class="w">        </span><span class="n">MenuItem</span><span class="w"> </span><span class="n">mi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">menu</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">itemId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;item not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mi</span><span class="p">.</span><span class="na">inStock</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;item out of stock&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Cart</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carts</span><span class="p">.</span><span class="na">byUser</span><span class="p">(</span><span class="n">userId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cart</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carts</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Cart</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;cart&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cart</span><span class="p">.</span><span class="na">restaurantId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">restaurantId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;cart restricted to 1 restaurant&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">CartItem</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cart</span><span class="p">.</span><span class="na">items</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">itemId</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CartItem</span><span class="p">(</span><span class="n">itemId</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="n">ci</span><span class="p">.</span><span class="na">qty</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">qty</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="p">.</span><span class="na">qty</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">cart</span><span class="p">.</span><span class="na">items</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">itemId</span><span class="p">);</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">cart</span><span class="p">.</span><span class="na">items</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">itemId</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">);</span>
<span class="w">        </span><span class="n">cart</span><span class="p">.</span><span class="na">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">carts</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">cart</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Cart</span><span class="w"> </span><span class="nf">removeItem</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">itemId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Cart</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carts</span><span class="p">.</span><span class="na">byUser</span><span class="p">(</span><span class="n">userId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;cart not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">cart</span><span class="p">.</span><span class="na">items</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">itemId</span><span class="p">);</span>
<span class="w">        </span><span class="n">cart</span><span class="p">.</span><span class="na">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">carts</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">cart</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="n">carts</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">OrderService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OrderRepo</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CartRepo</span><span class="w"> </span><span class="n">carts</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MenuRepo</span><span class="w"> </span><span class="n">menu</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PricingService</span><span class="w"> </span><span class="n">pricing</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RestaurantRepo</span><span class="w"> </span><span class="n">restaurants</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">OrderService</span><span class="p">(</span><span class="n">OrderRepo</span><span class="w"> </span><span class="n">o</span><span class="p">,</span><span class="w"> </span><span class="n">CartRepo</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">MenuRepo</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">PricingService</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">RestaurantRepo</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span>
<span class="w">        </span><span class="n">orders</span><span class="o">=</span><span class="n">o</span><span class="p">;</span><span class="n">carts</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="n">menu</span><span class="o">=</span><span class="n">m</span><span class="p">;</span><span class="n">pricing</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="n">restaurants</span><span class="o">=</span><span class="n">r</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="nf">place</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">instructions</span><span class="p">){</span>
<span class="w">        </span><span class="n">Cart</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carts</span><span class="p">.</span><span class="na">byUser</span><span class="p">(</span><span class="n">userId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;empty cart&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cart</span><span class="p">.</span><span class="na">items</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;empty cart&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Restaurant</span><span class="w"> </span><span class="n">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restaurants</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">cart</span><span class="p">.</span><span class="na">restaurantId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;restaurant&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// snapshot items</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">CartItem</span><span class="w"> </span><span class="n">ci</span><span class="p">:</span><span class="w"> </span><span class="n">cart</span><span class="p">.</span><span class="na">items</span><span class="p">.</span><span class="na">values</span><span class="p">()){</span>
<span class="w">            </span><span class="n">MenuItem</span><span class="w"> </span><span class="n">mi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">menu</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">ci</span><span class="p">.</span><span class="na">itemId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;menu item missing&quot;</span><span class="p">));</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mi</span><span class="p">.</span><span class="na">inStock</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;item went out of stock: &quot;</span><span class="o">+</span><span class="n">mi</span><span class="p">.</span><span class="na">name</span><span class="p">);</span>
<span class="w">            </span><span class="n">items</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OrderItem</span><span class="p">(</span><span class="n">mi</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">mi</span><span class="p">.</span><span class="na">name</span><span class="p">,</span><span class="w"> </span><span class="n">mi</span><span class="p">.</span><span class="na">price</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="na">qty</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="na">subTotal</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// distance approx: pretend user&#39;s address is 2km away baseline (for demo).</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">distKm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// could be from geocode(address)</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">delivery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="na">deliveryFee</span><span class="p">(</span><span class="n">distKm</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">tax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="na">tax</span><span class="p">(</span><span class="n">sub</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="na">total</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span><span class="w"> </span><span class="n">tax</span><span class="p">,</span><span class="w"> </span><span class="n">delivery</span><span class="p">);</span>
<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Order</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;ord&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">rest</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">instructions</span><span class="p">,</span><span class="w"> </span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="n">sub</span><span class="p">,</span><span class="w"> </span><span class="n">tax</span><span class="p">,</span><span class="w"> </span><span class="n">delivery</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>
<span class="w">        </span><span class="n">carts</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="c1">// clear cart</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setStatus</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">OrderStatus</span><span class="w"> </span><span class="n">st</span><span class="p">){</span>
<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">orderId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st</span><span class="p">;</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">PaymentService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PaymentRepo</span><span class="w"> </span><span class="n">payments</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OrderRepo</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">PaymentService</span><span class="p">(</span><span class="n">PaymentRepo</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">OrderRepo</span><span class="w"> </span><span class="n">o</span><span class="p">,</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">payments</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="n">orders</span><span class="o">=</span><span class="n">o</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Payment</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">txnRef</span><span class="p">){</span>
<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">orderId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Payment</span><span class="w"> </span><span class="n">pay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Payment</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;pay&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">txnRef</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">total</span><span class="p">);</span>
<span class="w">        </span><span class="n">pay</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="p">.</span><span class="na">PAID</span><span class="p">;</span><span class="w"> </span><span class="n">pay</span><span class="p">.</span><span class="na">paidAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="n">orders</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">o</span><span class="p">);</span><span class="w"> </span><span class="c1">// status handled externally</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payments</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">pay</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">AssignmentService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PartnerRepo</span><span class="w"> </span><span class="n">partners</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RestaurantRepo</span><span class="w"> </span><span class="n">restaurants</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OrderRepo</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>
<span class="w">    </span><span class="n">AssignmentService</span><span class="p">(</span><span class="n">PartnerRepo</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">RestaurantRepo</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">OrderRepo</span><span class="w"> </span><span class="n">o</span><span class="p">){</span><span class="n">partners</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="n">restaurants</span><span class="o">=</span><span class="n">r</span><span class="p">;</span><span class="n">orders</span><span class="o">=</span><span class="n">o</span><span class="p">;}</span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">DeliveryPartner</span><span class="w"> </span><span class="nf">assign</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">orderId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Restaurant</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restaurants</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">restaurantId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;restaurant&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DeliveryPartner</span><span class="o">&gt;</span><span class="w"> </span><span class="n">avail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partners</span><span class="p">.</span><span class="na">available</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avail</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no partner available&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// nearest partner by distance to restaurant</span>
<span class="w">        </span><span class="n">DeliveryPartner</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avail</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparingDouble</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">Haversine</span><span class="p">.</span><span class="na">distanceKm</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">loc</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">loc</span><span class="p">))).</span><span class="na">get</span><span class="p">();</span>
<span class="w">        </span><span class="n">best</span><span class="p">.</span><span class="na">available</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">km</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Haversine</span><span class="p">.</span><span class="na">distanceKm</span><span class="p">(</span><span class="n">best</span><span class="p">.</span><span class="na">loc</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">loc</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">eta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Haversine</span><span class="p">.</span><span class="na">etaMin</span><span class="p">(</span><span class="n">km</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span><span class="w"> </span><span class="c1">// add 2km headroom to destination</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="na">partnerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">best</span><span class="p">.</span><span class="na">id</span><span class="p">;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">etaMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eta</span><span class="p">;</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">best</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">markDelivered</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">orderId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">partnerId</span><span class="o">!=</span><span class="kc">null</span><span class="p">){</span>
<span class="w">            </span><span class="n">partners</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">partnerId</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="na">available</span><span class="o">=</span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">DELIVERED</span><span class="p">;</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">TrackingService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OrderRepo</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PartnerRepo</span><span class="w"> </span><span class="n">partners</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RestaurantRepo</span><span class="w"> </span><span class="n">restaurants</span><span class="p">;</span>
<span class="w">    </span><span class="n">TrackingService</span><span class="p">(</span><span class="n">OrderRepo</span><span class="w"> </span><span class="n">o</span><span class="p">,</span><span class="w"> </span><span class="n">PartnerRepo</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">RestaurantRepo</span><span class="w"> </span><span class="n">r</span><span class="p">){</span><span class="n">orders</span><span class="o">=</span><span class="n">o</span><span class="p">;</span><span class="n">partners</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="n">restaurants</span><span class="o">=</span><span class="n">r</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">track</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">orderId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">name</span><span class="p">());</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;etaMin&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">etaMin</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">partnerId</span><span class="o">!=</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">partners</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">partnerId</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="p">{</span>
<span class="w">                </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;partnerId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">                </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;partnerLoc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;lat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="na">loc</span><span class="p">.</span><span class="na">lat</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lon&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="na">loc</span><span class="p">.</span><span class="na">lon</span><span class="p">));</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Controller Facade ===== */</span>
<span class="kd">class</span> <span class="nc">FoodController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CatalogService</span><span class="w"> </span><span class="n">catalog</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CartService</span><span class="w"> </span><span class="n">carts</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OrderService</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PaymentService</span><span class="w"> </span><span class="n">payments</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AssignmentService</span><span class="w"> </span><span class="n">assign</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TrackingService</span><span class="w"> </span><span class="n">tracking</span><span class="p">;</span>

<span class="w">    </span><span class="n">FoodController</span><span class="p">(</span><span class="n">CatalogService</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">CartService</span><span class="w"> </span><span class="n">ca</span><span class="p">,</span><span class="w"> </span><span class="n">OrderService</span><span class="w"> </span><span class="n">o</span><span class="p">,</span><span class="w"> </span><span class="n">PaymentService</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">AssignmentService</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">TrackingService</span><span class="w"> </span><span class="n">t</span><span class="p">){</span>
<span class="w">        </span><span class="n">catalog</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="w"> </span><span class="n">carts</span><span class="o">=</span><span class="n">ca</span><span class="p">;</span><span class="w"> </span><span class="n">orders</span><span class="o">=</span><span class="n">o</span><span class="p">;</span><span class="w"> </span><span class="n">payments</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="n">assign</span><span class="o">=</span><span class="n">a</span><span class="p">;</span><span class="w"> </span><span class="n">tracking</span><span class="o">=</span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Restaurant</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getRestaurants</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">cuisine</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">search</span><span class="p">(</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">cuisine</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">MenuItem</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getMenu</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">menu</span><span class="p">(</span><span class="n">restaurantId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">Cart</span><span class="w"> </span><span class="nf">postCartAdd</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">itemId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">qty</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">carts</span><span class="p">.</span><span class="na">addItem</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">restaurantId</span><span class="p">,</span><span class="w"> </span><span class="n">itemId</span><span class="p">,</span><span class="w"> </span><span class="n">qty</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Cart</span><span class="w"> </span><span class="nf">deleteCartItem</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">itemId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">carts</span><span class="p">.</span><span class="na">removeItem</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">itemId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">Order</span><span class="w"> </span><span class="nf">postOrder</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">instructions</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">place</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">instructions</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Payment</span><span class="w"> </span><span class="nf">postPaymentConfirm</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">txnRef</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">payments</span><span class="p">.</span><span class="na">confirm</span><span class="p">(</span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">txnRef</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">DeliveryPartner</span><span class="w"> </span><span class="nf">postAssign</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">){</span>
<span class="w">        </span><span class="n">DeliveryPartner</span><span class="w"> </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assign</span><span class="p">.</span><span class="na">assign</span><span class="p">(</span><span class="n">orderId</span><span class="p">);</span>
<span class="w">        </span><span class="n">orders</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">PREPARING</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dp</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getTrack</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">tracking</span><span class="p">.</span><span class="na">track</span><span class="p">(</span><span class="n">orderId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Bootstrap &amp; Minimal Demo ===== */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SwiggyZomato40Min</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ids</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Repos</span>
<span class="w">        </span><span class="n">RestaurantRepo</span><span class="w"> </span><span class="n">restaurants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestaurantRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">MenuRepo</span><span class="w"> </span><span class="n">menu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MenuRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">CartRepo</span><span class="w"> </span><span class="n">carts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CartRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">OrderRepo</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">PaymentRepo</span><span class="w"> </span><span class="n">pays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaymentRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">PartnerRepo</span><span class="w"> </span><span class="n">partners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PartnerRepo</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Seed Restaurants &amp; Menu</span>
<span class="w">        </span><span class="n">Restaurant</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restaurants</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Restaurant</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;rest&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Punjabi Zaika&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;HSR&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;NorthIndian&quot;</span><span class="p">,</span><span class="s">&quot;Biryani&quot;</span><span class="p">),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GeoPoint</span><span class="p">(</span><span class="mf">12.91</span><span class="p">,</span><span class="mf">77.64</span><span class="p">),</span><span class="w"> </span><span class="mf">4.4</span><span class="p">));</span>
<span class="w">        </span><span class="n">Restaurant</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restaurants</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Restaurant</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;rest&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Veggie Delite&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;HSR&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;SouthIndian&quot;</span><span class="p">,</span><span class="s">&quot;Healthy&quot;</span><span class="p">),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GeoPoint</span><span class="p">(</span><span class="mf">12.905</span><span class="p">,</span><span class="mf">77.64</span><span class="p">),</span><span class="w"> </span><span class="mf">4.6</span><span class="p">));</span>

<span class="w">        </span><span class="n">menu</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MenuItem</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Butter Chicken&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">280</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>
<span class="w">        </span><span class="n">menu</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MenuItem</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dal Makhani&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>
<span class="w">        </span><span class="n">menu</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MenuItem</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Veg Thali&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">220</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Partners</span>
<span class="w">        </span><span class="n">partners</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DeliveryPartner</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;dp&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Ravi&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GeoPoint</span><span class="p">(</span><span class="mf">12.90</span><span class="p">,</span><span class="mf">77.62</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="mf">4.8</span><span class="p">));</span>
<span class="w">        </span><span class="n">partners</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DeliveryPartner</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;dp&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Kiran&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GeoPoint</span><span class="p">(</span><span class="mf">12.92</span><span class="p">,</span><span class="mf">77.65</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="mf">4.5</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Services</span>
<span class="w">        </span><span class="n">CatalogService</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CatalogService</span><span class="p">(</span><span class="n">restaurants</span><span class="p">,</span><span class="w"> </span><span class="n">menu</span><span class="p">);</span>
<span class="w">        </span><span class="n">PricingService</span><span class="w"> </span><span class="n">pricing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PricingService</span><span class="p">();</span>
<span class="w">        </span><span class="n">CartService</span><span class="w"> </span><span class="n">cartSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CartService</span><span class="p">(</span><span class="n">carts</span><span class="p">,</span><span class="w"> </span><span class="n">menu</span><span class="p">,</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">OrderService</span><span class="w"> </span><span class="n">orderSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderService</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span><span class="w"> </span><span class="n">carts</span><span class="p">,</span><span class="w"> </span><span class="n">menu</span><span class="p">,</span><span class="w"> </span><span class="n">pricing</span><span class="p">,</span><span class="w"> </span><span class="n">restaurants</span><span class="p">,</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">PaymentService</span><span class="w"> </span><span class="n">paymentSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaymentService</span><span class="p">(</span><span class="n">pays</span><span class="p">,</span><span class="w"> </span><span class="n">orders</span><span class="p">,</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">AssignmentService</span><span class="w"> </span><span class="n">assign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AssignmentService</span><span class="p">(</span><span class="n">partners</span><span class="p">,</span><span class="w"> </span><span class="n">restaurants</span><span class="p">,</span><span class="w"> </span><span class="n">orders</span><span class="p">);</span>
<span class="w">        </span><span class="n">TrackingService</span><span class="w"> </span><span class="n">tracking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TrackingService</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span><span class="w"> </span><span class="n">partners</span><span class="p">,</span><span class="w"> </span><span class="n">restaurants</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Controller</span>
<span class="w">        </span><span class="n">FoodController</span><span class="w"> </span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FoodController</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span><span class="w"> </span><span class="n">cartSvc</span><span class="p">,</span><span class="w"> </span><span class="n">orderSvc</span><span class="p">,</span><span class="w"> </span><span class="n">paymentSvc</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p">,</span><span class="w"> </span><span class="n">tracking</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// --- Demo like API calls ---</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;GET /restaurants?area=HSR&amp;cuisine=NorthIndian\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getRestaurants</span><span class="p">(</span><span class="s">&quot;HSR&quot;</span><span class="p">,</span><span class="s">&quot;NorthIndian&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nGET /restaurants/{id}/menu\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getMenu</span><span class="p">(</span><span class="n">r1</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user-007&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postCartAdd</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getMenu</span><span class="p">(</span><span class="n">r1</span><span class="p">.</span><span class="na">id</span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postCartAdd</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getMenu</span><span class="p">(</span><span class="n">r1</span><span class="p">.</span><span class="na">id</span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nPOST /cart/items -&gt; cart items: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="na">items</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">.</span><span class="na">itemId</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">ci</span><span class="p">.</span><span class="na">qty</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">()));</span>

<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">ord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postOrder</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;HSR Layout, Bengaluru&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Less spicy&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nPOST /orders -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ord</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; total=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ord</span><span class="p">.</span><span class="na">total</span><span class="p">);</span>

<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">pay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postPaymentConfirm</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UPI&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TXN-42&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">orders</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="na">id</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">o</span><span class="p">.</span><span class="na">status</span><span class="o">=</span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">PAID</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;POST /payments/confirm -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pay</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; amount=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pay</span><span class="p">.</span><span class="na">amount</span><span class="p">);</span>

<span class="w">        </span><span class="n">DeliveryPartner</span><span class="w"> </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postAssign</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nPOST /orders/{id}/assign -&gt; partner=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; etaMin=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="na">id</span><span class="p">).</span><span class="na">get</span><span class="p">().</span><span class="na">etaMin</span><span class="p">);</span>

<span class="w">        </span><span class="n">orders</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="na">id</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">o</span><span class="p">.</span><span class="na">status</span><span class="o">=</span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">PICKED_UP</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nGET /orders/{id}/track -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getTrack</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>

<span class="w">        </span><span class="n">assign</span><span class="p">.</span><span class="na">markDelivered</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;\nDelivered. Track -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getTrack</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="ride-sharing">Ride Sharing<a class="headerlink" href="#ride-sharing" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>/*
Template -&gt;
1) define functional requirements
   - Rider requests a ride (pickup, drop, carType).
   - System matches nearest available driver; returns ETA &amp; fare estimate.
   - Rider can confirm -&gt; ride gets ACCEPTED; driver can start and end trip.
   - Pricing = base + perKm + perMin with simple surge (demand/supply).
   - Track ride: live status, driver location, ETA.
   - Payment confirmation (stub) after completion.
   - In-memory, single city, thread-safe where needed — doable in ~40 min.

2) define entities / actors
   Actors: Rider, Driver
   Entities: Rider, Driver(availability, loc), Ride(status lifecycle), Payment

3) define apis - get/post/put, request, response
   POST /riders                       {name} -&gt; {riderId}
   POST /drivers                      {name, carType, lat, lon} -&gt; {driverId}
   PUT  /drivers/{id}/location        {lat, lon, available} -&gt; {ok}
   POST /rides/quote                  {riderId, pickup{lat,lon}, drop{lat,lon}, carType} -&gt; {quoteId, driverId, etaMin, fareEstimate}
   POST /rides/confirm                {quoteId} -&gt; {rideId, status}
   POST /rides/{rideId}/start         {} -&gt; {status}
   POST /rides/{rideId}/end           {} -&gt; {fare, status}
   POST /payments                     {rideId, method, txnRef?} -&gt; {paymentId, status}
   GET  /rides/{rideId}/track         -&gt; {status, driverLoc, etaMin}

4) define services involved
   MatchingService     - nearest available driver by carType.
   PricingService      - distance, time estimate, fare + surge.
   RideService         - create/confirm/start/end rides, state machine.
   DriverService       - update location/availability.
   PaymentService      - confirm payments (stub).
   TrackingService     - ETA/status view.
   IdGenerator         - generate IDs.

5) define db schema - what all tables are required, what are the columns, what are the keys
   rider(id PK, name, created_at)
   driver(id PK, name, car_type, lat, lon, available BOOL, rating)
   ride(id PK, rider_id FK, driver_id FK, pickup_lat, pickup_lon, drop_lat, drop_lon, car_type, 
        requested_at, accepted_at, started_at, ended_at, distance_km, duration_min, fare, status)
   payment(id PK, ride_id FK UNIQUE, method, amount, status, txn_ref, paid_at)
*/
</code></pre></div>
<h3 id="java-implementation_3">Java Implementation<a class="headerlink" href="#java-implementation_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">Template -&gt;</span>
<span class="cm">1) define functional requirements</span>
<span class="cm">   - Rider requests a ride (pickup, drop, carType).</span>
<span class="cm">   - System matches nearest available driver; returns ETA &amp; fare estimate.</span>
<span class="cm">   - Rider can confirm -&gt; ride gets ACCEPTED; driver can start and end trip.</span>
<span class="cm">   - Pricing = base + perKm + perMin with simple surge (demand/supply).</span>
<span class="cm">   - Track ride: live status, driver location, ETA.</span>
<span class="cm">   - Payment confirmation (stub) after completion.</span>
<span class="cm">   - In-memory, single city, thread-safe where needed — doable in ~40 min.</span>

<span class="cm">2) define entities / actors</span>
<span class="cm">   Actors: Rider, Driver</span>
<span class="cm">   Entities: Rider, Driver(availability, loc), Ride(status lifecycle), Payment</span>

<span class="cm">3) define apis - get/post/put, request, response</span>
<span class="cm">   POST /riders                       {name} -&gt; {riderId}</span>
<span class="cm">   POST /drivers                      {name, carType, lat, lon} -&gt; {driverId}</span>
<span class="cm">   PUT  /drivers/{id}/location        {lat, lon, available} -&gt; {ok}</span>
<span class="cm">   POST /rides/quote                  {riderId, pickup{lat,lon}, drop{lat,lon}, carType} -&gt; {quoteId, driverId, etaMin, fareEstimate}</span>
<span class="cm">   POST /rides/confirm                {quoteId} -&gt; {rideId, status}</span>
<span class="cm">   POST /rides/{rideId}/start         {} -&gt; {status}</span>
<span class="cm">   POST /rides/{rideId}/end           {} -&gt; {fare, status}</span>
<span class="cm">   POST /payments                     {rideId, method, txnRef?} -&gt; {paymentId, status}</span>
<span class="cm">   GET  /rides/{rideId}/track         -&gt; {status, driverLoc, etaMin}</span>

<span class="cm">4) define services involved</span>
<span class="cm">   MatchingService     - nearest available driver by carType.</span>
<span class="cm">   PricingService      - distance, time estimate, fare + surge.</span>
<span class="cm">   RideService         - create/confirm/start/end rides, state machine.</span>
<span class="cm">   DriverService       - update location/availability.</span>
<span class="cm">   PaymentService      - confirm payments (stub).</span>
<span class="cm">   TrackingService     - ETA/status view.</span>
<span class="cm">   IdGenerator         - generate IDs.</span>

<span class="cm">5) define db schema - what all tables are required, what are the columns, what are the keys</span>
<span class="cm">   rider(id PK, name, created_at)</span>
<span class="cm">   driver(id PK, name, car_type, lat, lon, available BOOL, rating)</span>
<span class="cm">   ride(id PK, rider_id FK, driver_id FK, pickup_lat, pickup_lon, drop_lat, drop_lon, car_type, </span>
<span class="cm">        requested_at, accepted_at, started_at, ended_at, distance_km, duration_min, fare, status)</span>
<span class="cm">   payment(id PK, ride_id FK UNIQUE, method, amount, status, txn_ref, paid_at)</span>
<span class="cm">*/</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="cm">/* ===== Domain ===== */</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">CarType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">MINI</span><span class="p">,</span><span class="w"> </span><span class="n">SEDAN</span><span class="p">,</span><span class="w"> </span><span class="n">SUV</span><span class="w"> </span><span class="p">}</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">RideStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">QUOTED</span><span class="p">,</span><span class="w"> </span><span class="n">ACCEPTED</span><span class="p">,</span><span class="w"> </span><span class="n">ONGOING</span><span class="p">,</span><span class="w"> </span><span class="n">COMPLETED</span><span class="p">,</span><span class="w"> </span><span class="n">CANCELLED</span><span class="w"> </span><span class="p">}</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">PENDING</span><span class="p">,</span><span class="w"> </span><span class="n">PAID</span><span class="p">,</span><span class="w"> </span><span class="n">FAILED</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Geo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="p">;</span><span class="w"> </span><span class="n">Geo</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">lon</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Rider</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span><span class="w"> </span><span class="n">Rider</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">n</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">n</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Driver</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CarType</span><span class="w"> </span><span class="n">carType</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Geo</span><span class="w"> </span><span class="n">loc</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">available</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">rating</span><span class="p">;</span>
<span class="w">    </span><span class="n">Driver</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="n">CarType</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="n">Geo</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">r</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">carType</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">loc</span><span class="o">=</span><span class="n">l</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">rating</span><span class="o">=</span><span class="n">r</span><span class="p">;}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Ride</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">riderId</span><span class="p">;</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">driverId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">CarType</span><span class="w"> </span><span class="n">carType</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Geo</span><span class="w"> </span><span class="n">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">drop</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">requestedAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">acceptedAt</span><span class="p">,</span><span class="w"> </span><span class="n">startedAt</span><span class="p">,</span><span class="w"> </span><span class="n">endedAt</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">distanceKm</span><span class="p">,</span><span class="w"> </span><span class="n">durationMin</span><span class="p">,</span><span class="w"> </span><span class="n">fare</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">RideStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RideStatus</span><span class="p">.</span><span class="na">QUOTED</span><span class="p">;</span><span class="w"> </span><span class="c1">// after quote; becomes ACCEPTED on confirm</span>
<span class="w">    </span><span class="n">Ride</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">riderId</span><span class="p">,</span><span class="n">CarType</span><span class="w"> </span><span class="n">carType</span><span class="p">,</span><span class="n">Geo</span><span class="w"> </span><span class="n">pickup</span><span class="p">,</span><span class="n">Geo</span><span class="w"> </span><span class="n">drop</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">riderId</span><span class="o">=</span><span class="n">riderId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">carType</span><span class="o">=</span><span class="n">carType</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">pickup</span><span class="o">=</span><span class="n">pickup</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">drop</span><span class="o">=</span><span class="n">drop</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Payment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">rideId</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">txnRef</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="n">PaymentStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">paidAt</span><span class="p">;</span>
<span class="w">    </span><span class="n">Payment</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">txnRef</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">rideId</span><span class="o">=</span><span class="n">rideId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">method</span><span class="o">=</span><span class="n">method</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">txnRef</span><span class="o">=</span><span class="n">txnRef</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Utils ===== */</span>
<span class="kd">class</span> <span class="nc">Ids</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">n</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">();}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">Haversine</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">km</span><span class="p">(</span><span class="n">Geo</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">Geo</span><span class="w"> </span><span class="n">b</span><span class="p">){</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">R</span><span class="o">=</span><span class="mi">6371</span><span class="p">,</span><span class="w"> </span><span class="n">dLat</span><span class="o">=</span><span class="n">Math</span><span class="p">.</span><span class="na">toRadians</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">lat</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="na">lat</span><span class="p">),</span><span class="w"> </span><span class="n">dLon</span><span class="o">=</span><span class="n">Math</span><span class="p">.</span><span class="na">toRadians</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">lon</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="na">lon</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">s1</span><span class="o">=</span><span class="n">Math</span><span class="p">.</span><span class="na">sin</span><span class="p">(</span><span class="n">dLat</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">s2</span><span class="o">=</span><span class="n">Math</span><span class="p">.</span><span class="na">sin</span><span class="p">(</span><span class="n">dLon</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">h</span><span class="o">=</span><span class="n">s1</span><span class="o">*</span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">cos</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">toRadians</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">lat</span><span class="p">))</span><span class="o">*</span><span class="n">Math</span><span class="p">.</span><span class="na">cos</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">toRadians</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">lat</span><span class="p">))</span><span class="o">*</span><span class="n">s2</span><span class="o">*</span><span class="n">s2</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">R</span><span class="o">*</span><span class="n">Math</span><span class="p">.</span><span class="na">asin</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">sqrt</span><span class="p">(</span><span class="n">h</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Repos (in-memory) ===== */</span>
<span class="kd">class</span> <span class="nc">RiderRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Rider</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Rider</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Rider</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Rider</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">DriverRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Driver</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Driver</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Driver</span><span class="w"> </span><span class="n">d</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">d</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">d</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Driver</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Driver</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">availableByType</span><span class="p">(</span><span class="n">CarType</span><span class="w"> </span><span class="n">t</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="na">available</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="na">carType</span><span class="o">==</span><span class="n">t</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">RideRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Ride</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Ride</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Ride</span><span class="w"> </span><span class="n">r</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">r</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Ride</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">PaymentRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Payment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Payment</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Payment</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">p</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byRide</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="na">rideId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">rideId</span><span class="p">)).</span><span class="na">findFirst</span><span class="p">();}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Services ===== */</span>
<span class="kd">class</span> <span class="nc">DriverService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DriverRepo</span><span class="w"> </span><span class="n">drivers</span><span class="p">;</span>
<span class="w">    </span><span class="n">DriverService</span><span class="p">(</span><span class="n">DriverRepo</span><span class="w"> </span><span class="n">d</span><span class="p">){</span><span class="n">drivers</span><span class="o">=</span><span class="n">d</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Driver</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lon</span><span class="p">){</span>
<span class="w">        </span><span class="n">Driver</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Driver</span><span class="p">(</span><span class="n">Uber40Min</span><span class="p">.</span><span class="na">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;drv&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Geo</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">),</span><span class="w"> </span><span class="mf">4.7</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateLocation</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">driverId</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">available</span><span class="p">){</span>
<span class="w">        </span><span class="n">Driver</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">driverId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;driver&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">d</span><span class="p">.</span><span class="na">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Geo</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">);</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="na">available</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available</span><span class="p">;</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">PricingService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// base fare per car type</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">CarType</span><span class="p">,</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">CarType</span><span class="p">.</span><span class="na">MINI</span><span class="p">,</span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">SEDAN</span><span class="p">,</span><span class="mf">40.0</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">SUV</span><span class="p">,</span><span class="mf">55.0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">CarType</span><span class="p">,</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">PER_KM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">CarType</span><span class="p">.</span><span class="na">MINI</span><span class="p">,</span><span class="mf">12.0</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">SEDAN</span><span class="p">,</span><span class="mf">14.0</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">SUV</span><span class="p">,</span><span class="mf">18.0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">CarType</span><span class="p">,</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">PER_MIN</span><span class="o">=</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">CarType</span><span class="p">.</span><span class="na">MINI</span><span class="p">,</span><span class="mf">1.5</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">SEDAN</span><span class="p">,</span><span class="mf">2.0</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">SUV</span><span class="p">,</span><span class="mf">2.5</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="nf">surgeFactor</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">demand</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">supply</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">supply</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">demand</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">supply</span><span class="p">;</span><span class="w"> </span><span class="c1">// &gt;1 means surge</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">ratio</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="mf">0.8</span><span class="p">));</span><span class="w"> </span><span class="c1">// soft clamp</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="nf">estimateFare</span><span class="p">(</span><span class="n">CarType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">km</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">minutes</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">surge</span><span class="p">){</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">fare</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PER_KM</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="o">*</span><span class="n">km</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PER_MIN</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="o">*</span><span class="n">minutes</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">round2</span><span class="p">(</span><span class="n">fare</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">surge</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">round2</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">v</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MatchingService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DriverRepo</span><span class="w"> </span><span class="n">drivers</span><span class="p">;</span>
<span class="w">    </span><span class="n">MatchingService</span><span class="p">(</span><span class="n">DriverRepo</span><span class="w"> </span><span class="n">d</span><span class="p">){</span><span class="n">drivers</span><span class="o">=</span><span class="n">d</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Driver</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">nearest</span><span class="p">(</span><span class="n">CarType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">Geo</span><span class="w"> </span><span class="n">pickup</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">availableByType</span><span class="p">(</span><span class="n">type</span><span class="p">).</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparingDouble</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">Haversine</span><span class="p">.</span><span class="na">km</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="na">loc</span><span class="p">,</span><span class="w"> </span><span class="n">pickup</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Quote</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">riderId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CarType</span><span class="w"> </span><span class="n">carType</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Geo</span><span class="w"> </span><span class="n">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">drop</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">driverId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">etaMin</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">fareEstimate</span><span class="p">;</span>
<span class="w">    </span><span class="n">Quote</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">riderId</span><span class="p">,</span><span class="n">CarType</span><span class="w"> </span><span class="n">carType</span><span class="p">,</span><span class="n">Geo</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="n">Geo</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">driverId</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">etaMin</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">fare</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">riderId</span><span class="o">=</span><span class="n">riderId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">carType</span><span class="o">=</span><span class="n">carType</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">pickup</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">drop</span><span class="o">=</span><span class="n">d</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">driverId</span><span class="o">=</span><span class="n">driverId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">etaMin</span><span class="o">=</span><span class="n">etaMin</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">fareEstimate</span><span class="o">=</span><span class="n">fare</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">RideService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RideRepo</span><span class="w"> </span><span class="n">rides</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DriverRepo</span><span class="w"> </span><span class="n">drivers</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MatchingService</span><span class="w"> </span><span class="n">match</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PricingService</span><span class="w"> </span><span class="n">pricing</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Quote</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quotes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="n">RideService</span><span class="p">(</span><span class="n">RideRepo</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">DriverRepo</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">MatchingService</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">PricingService</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="n">rides</span><span class="o">=</span><span class="n">r</span><span class="p">;</span><span class="n">drivers</span><span class="o">=</span><span class="n">d</span><span class="p">;</span><span class="n">match</span><span class="o">=</span><span class="n">m</span><span class="p">;</span><span class="n">pricing</span><span class="o">=</span><span class="n">p</span><span class="p">;}</span>

<span class="w">    </span><span class="n">Quote</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">riderId</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">Geo</span><span class="w"> </span><span class="n">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">Geo</span><span class="w"> </span><span class="n">drop</span><span class="p">){</span>
<span class="w">        </span><span class="c1">// naive ETA: distance from driver to pickup at 22km/h</span>
<span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Driver</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">match</span><span class="p">.</span><span class="na">nearest</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">pickup</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cand</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;no driver available&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Driver</span><span class="w"> </span><span class="n">drv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cand</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">distToPickupKm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Haversine</span><span class="p">.</span><span class="na">km</span><span class="p">(</span><span class="n">drv</span><span class="p">.</span><span class="na">loc</span><span class="p">,</span><span class="w"> </span><span class="n">pickup</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">etaMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="n">distToPickupKm</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">0.37</span><span class="p">));</span><span class="w"> </span><span class="c1">// ~22 km/h</span>

<span class="w">        </span><span class="c1">// trip distance &amp; duration estimate</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">tripKm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Haversine</span><span class="p">.</span><span class="na">km</span><span class="p">(</span><span class="n">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">drop</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 20% road factor</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">tripKm</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">0.35</span><span class="p">);</span><span class="w">     </span><span class="c1">// ~21 km/h avg</span>

<span class="w">        </span><span class="c1">// surge factor from simple demand/supply around car type</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">demand</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">supply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">availableByType</span><span class="p">(</span><span class="n">type</span><span class="p">).</span><span class="na">size</span><span class="p">();</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">surge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="na">surgeFactor</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span><span class="w"> </span><span class="n">supply</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="na">estimateFare</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">tripKm</span><span class="p">,</span><span class="w"> </span><span class="n">minutes</span><span class="p">,</span><span class="w"> </span><span class="n">surge</span><span class="p">);</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">qid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uber40Min</span><span class="p">.</span><span class="na">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;quote&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Quote</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Quote</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span><span class="w"> </span><span class="n">riderId</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">drop</span><span class="p">,</span><span class="w"> </span><span class="n">drv</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">etaMin</span><span class="p">,</span><span class="w"> </span><span class="n">estimate</span><span class="p">);</span>
<span class="w">        </span><span class="n">quotes</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Ride</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">quoteId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Quote</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">quotes</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">quoteId</span><span class="p">)).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;quote expired&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Driver</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="na">driverId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;driver missing&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">.</span><span class="na">available</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;driver just got busy&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">d</span><span class="p">.</span><span class="na">available</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

<span class="w">        </span><span class="n">Ride</span><span class="w"> </span><span class="n">ride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ride</span><span class="p">(</span><span class="n">Uber40Min</span><span class="p">.</span><span class="na">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;ride&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="na">riderId</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="na">carType</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="na">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="na">drop</span><span class="p">);</span>
<span class="w">        </span><span class="n">ride</span><span class="p">.</span><span class="na">driverId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="na">driverId</span><span class="p">;</span>
<span class="w">        </span><span class="n">ride</span><span class="p">.</span><span class="na">acceptedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="n">ride</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RideStatus</span><span class="p">.</span><span class="na">ACCEPTED</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">rides</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">ride</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Ride</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Ride</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rides</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">rideId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;ride&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RideStatus</span><span class="p">.</span><span class="na">ACCEPTED</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;not ready to start&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">startedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RideStatus</span><span class="p">.</span><span class="na">ONGOING</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">rides</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Ride</span><span class="w"> </span><span class="nf">end</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Ride</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rides</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">rideId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;ride&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RideStatus</span><span class="p">.</span><span class="na">ONGOING</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;not ongoing&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">endedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// compute actuals (in demo use straight estimates)</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">tripKm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Haversine</span><span class="p">.</span><span class="na">km</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">drop</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.2</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">between</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">startedAt</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">endedAt</span><span class="p">).</span><span class="na">toMinutes</span><span class="p">());</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">surge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">distanceKm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round2</span><span class="p">(</span><span class="n">tripKm</span><span class="p">);</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">durationMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round2</span><span class="p">(</span><span class="n">minutes</span><span class="p">);</span>
<span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">fare</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PricingService</span><span class="p">.</span><span class="na">round2</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PricingService</span><span class="p">().</span><span class="na">estimateFare</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">carType</span><span class="p">,</span><span class="w"> </span><span class="n">tripKm</span><span class="p">,</span><span class="w"> </span><span class="n">minutes</span><span class="p">,</span><span class="w"> </span><span class="n">surge</span><span class="p">));</span>
<span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RideStatus</span><span class="p">.</span><span class="na">COMPLETED</span><span class="p">;</span>
<span class="w">        </span><span class="n">rides</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// free driver</span>
<span class="w">        </span><span class="n">Driver</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">driverId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<span class="w">        </span><span class="n">d</span><span class="p">.</span><span class="na">available</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">round2</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">v</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">PaymentService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PaymentRepo</span><span class="w"> </span><span class="n">payments</span><span class="p">;</span><span class="w"> </span><span class="n">PaymentService</span><span class="p">(</span><span class="n">PaymentRepo</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="n">payments</span><span class="o">=</span><span class="n">p</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Payment</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">txnRef</span><span class="p">){</span>
<span class="w">        </span><span class="n">Payment</span><span class="w"> </span><span class="n">pay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Payment</span><span class="p">(</span><span class="n">Uber40Min</span><span class="p">.</span><span class="na">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;pay&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">rideId</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">txnRef</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">);</span>
<span class="w">        </span><span class="n">pay</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PaymentStatus</span><span class="p">.</span><span class="na">PAID</span><span class="p">;</span><span class="w"> </span><span class="n">pay</span><span class="p">.</span><span class="na">paidAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payments</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">pay</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">TrackingService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RideRepo</span><span class="w"> </span><span class="n">rides</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DriverRepo</span><span class="w"> </span><span class="n">drivers</span><span class="p">;</span>
<span class="w">    </span><span class="n">TrackingService</span><span class="p">(</span><span class="n">RideRepo</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">DriverRepo</span><span class="w"> </span><span class="n">d</span><span class="p">){</span><span class="n">rides</span><span class="o">=</span><span class="n">r</span><span class="p">;</span><span class="n">drivers</span><span class="o">=</span><span class="n">d</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">track</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Ride</span><span class="w"> </span><span class="n">ride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rides</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">rideId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;ride&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ride</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">name</span><span class="p">());</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ride</span><span class="p">.</span><span class="na">driverId</span><span class="o">!=</span><span class="kc">null</span><span class="p">){</span>
<span class="w">            </span><span class="n">Driver</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drivers</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">ride</span><span class="p">.</span><span class="na">driverId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="o">!=</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;driverId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">                </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;driverLoc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;lat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="na">loc</span><span class="p">.</span><span class="na">lat</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lon&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="na">loc</span><span class="p">.</span><span class="na">lon</span><span class="p">));</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">eta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ride</span><span class="p">.</span><span class="na">status</span><span class="o">==</span><span class="n">RideStatus</span><span class="p">.</span><span class="na">ACCEPTED</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="n">Haversine</span><span class="p">.</span><span class="na">km</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="na">loc</span><span class="p">,</span><span class="w"> </span><span class="n">ride</span><span class="p">.</span><span class="na">pickup</span><span class="p">)</span><span class="o">/</span><span class="mf">0.37</span><span class="p">))</span><span class="w"> </span><span class="p">:</span>
<span class="w">                          </span><span class="n">ride</span><span class="p">.</span><span class="na">status</span><span class="o">==</span><span class="n">RideStatus</span><span class="p">.</span><span class="na">ONGOING</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="na">round</span><span class="p">(</span><span class="n">Haversine</span><span class="p">.</span><span class="na">km</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="na">loc</span><span class="p">,</span><span class="w"> </span><span class="n">ride</span><span class="p">.</span><span class="na">drop</span><span class="p">)</span><span class="o">/</span><span class="mf">0.37</span><span class="p">))</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;etaMin&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">eta</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Controller Facade (mirrors APIs) ===== */</span>
<span class="kd">class</span> <span class="nc">UberController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DriverService</span><span class="w"> </span><span class="n">driverSvc</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RideService</span><span class="w"> </span><span class="n">rideSvc</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PricingService</span><span class="w"> </span><span class="n">pricing</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PaymentService</span><span class="w"> </span><span class="n">paySvc</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TrackingService</span><span class="w"> </span><span class="n">tracking</span><span class="p">;</span>

<span class="w">    </span><span class="n">UberController</span><span class="p">(</span><span class="n">DriverService</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">RideService</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">PricingService</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">PaymentService</span><span class="w"> </span><span class="n">pay</span><span class="p">,</span><span class="w"> </span><span class="n">TrackingService</span><span class="w"> </span><span class="n">t</span><span class="p">){</span>
<span class="w">        </span><span class="n">driverSvc</span><span class="o">=</span><span class="n">d</span><span class="p">;</span><span class="w"> </span><span class="n">rideSvc</span><span class="o">=</span><span class="n">r</span><span class="p">;</span><span class="w"> </span><span class="n">pricing</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="n">paySvc</span><span class="o">=</span><span class="n">pay</span><span class="p">;</span><span class="w"> </span><span class="n">tracking</span><span class="o">=</span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Rider</span><span class="w"> </span><span class="nf">postRider</span><span class="p">(</span><span class="n">RiderRepo</span><span class="w"> </span><span class="n">riders</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span><span class="w"> </span><span class="n">Rider</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Rider</span><span class="p">(</span><span class="n">Uber40Min</span><span class="p">.</span><span class="na">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">riders</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">r</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Driver</span><span class="w"> </span><span class="nf">postDriver</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lon</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">driverSvc</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">putDriverLocation</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">driverId</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">available</span><span class="p">){</span><span class="w"> </span><span class="n">driverSvc</span><span class="p">.</span><span class="na">updateLocation</span><span class="p">(</span><span class="n">driverId</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">Quote</span><span class="w"> </span><span class="nf">postQuote</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">riderId</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">Geo</span><span class="w"> </span><span class="n">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">Geo</span><span class="w"> </span><span class="n">drop</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">rideSvc</span><span class="p">.</span><span class="na">quote</span><span class="p">(</span><span class="n">riderId</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">drop</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Ride</span><span class="w"> </span><span class="nf">postConfirm</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">quoteId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">rideSvc</span><span class="p">.</span><span class="na">confirm</span><span class="p">(</span><span class="n">quoteId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Ride</span><span class="w"> </span><span class="nf">postStart</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">rideSvc</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">rideId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Ride</span><span class="w"> </span><span class="nf">postEnd</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">rideSvc</span><span class="p">.</span><span class="na">end</span><span class="p">(</span><span class="n">rideId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Payment</span><span class="w"> </span><span class="nf">postPayment</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">txnRef</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">paySvc</span><span class="p">.</span><span class="na">confirm</span><span class="p">(</span><span class="n">rideId</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">txnRef</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getTrack</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">rideId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">tracking</span><span class="p">.</span><span class="na">track</span><span class="p">(</span><span class="n">rideId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Demo (tiny, 40-min friendly) ===== */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Uber40Min</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ids</span><span class="p">();</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Repos</span>
<span class="w">        </span><span class="n">RiderRepo</span><span class="w"> </span><span class="n">riders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RiderRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">DriverRepo</span><span class="w"> </span><span class="n">drivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DriverRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">RideRepo</span><span class="w"> </span><span class="n">rideRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RideRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">PaymentRepo</span><span class="w"> </span><span class="n">payRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaymentRepo</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Services</span>
<span class="w">        </span><span class="n">DriverService</span><span class="w"> </span><span class="n">driverSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DriverService</span><span class="p">(</span><span class="n">drivers</span><span class="p">);</span>
<span class="w">        </span><span class="n">PricingService</span><span class="w"> </span><span class="n">pricing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PricingService</span><span class="p">();</span>
<span class="w">        </span><span class="n">MatchingService</span><span class="w"> </span><span class="n">matcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MatchingService</span><span class="p">(</span><span class="n">drivers</span><span class="p">);</span>
<span class="w">        </span><span class="n">RideService</span><span class="w"> </span><span class="n">rideSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RideService</span><span class="p">(</span><span class="n">rideRepo</span><span class="p">,</span><span class="w"> </span><span class="n">drivers</span><span class="p">,</span><span class="w"> </span><span class="n">matcher</span><span class="p">,</span><span class="w"> </span><span class="n">pricing</span><span class="p">);</span>
<span class="w">        </span><span class="n">PaymentService</span><span class="w"> </span><span class="n">paySvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaymentService</span><span class="p">(</span><span class="n">payRepo</span><span class="p">);</span>
<span class="w">        </span><span class="n">TrackingService</span><span class="w"> </span><span class="n">tracking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TrackingService</span><span class="p">(</span><span class="n">rideRepo</span><span class="p">,</span><span class="w"> </span><span class="n">drivers</span><span class="p">);</span>

<span class="w">        </span><span class="n">UberController</span><span class="w"> </span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UberController</span><span class="p">(</span><span class="n">driverSvc</span><span class="p">,</span><span class="w"> </span><span class="n">rideSvc</span><span class="p">,</span><span class="w"> </span><span class="n">pricing</span><span class="p">,</span><span class="w"> </span><span class="n">paySvc</span><span class="p">,</span><span class="w"> </span><span class="n">tracking</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Seed riders &amp; drivers</span>
<span class="w">        </span><span class="n">Rider</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postRider</span><span class="p">(</span><span class="n">riders</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Aarav&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Driver</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postDriver</span><span class="p">(</span><span class="s">&quot;Ravi&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">SEDAN</span><span class="p">,</span><span class="w"> </span><span class="mf">12.912</span><span class="p">,</span><span class="w"> </span><span class="mf">77.641</span><span class="p">);</span>
<span class="w">        </span><span class="n">Driver</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postDriver</span><span class="p">(</span><span class="s">&quot;Kiran&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">SEDAN</span><span class="p">,</span><span class="w"> </span><span class="mf">12.915</span><span class="p">,</span><span class="w"> </span><span class="mf">77.63</span><span class="p">);</span>
<span class="w">        </span><span class="n">Driver</span><span class="w"> </span><span class="n">d3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postDriver</span><span class="p">(</span><span class="s">&quot;Rohit&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">MINI</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mf">12.90</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mf">77.62</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Rider requests a quote (SEDAN)</span>
<span class="w">        </span><span class="n">Geo</span><span class="w"> </span><span class="n">pickup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Geo</span><span class="p">(</span><span class="mf">12.914</span><span class="p">,</span><span class="w"> </span><span class="mf">77.638</span><span class="p">);</span>
<span class="w">        </span><span class="n">Geo</span><span class="w"> </span><span class="n">drop</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Geo</span><span class="p">(</span><span class="mf">12.935</span><span class="p">,</span><span class="w"> </span><span class="mf">77.624</span><span class="p">);</span>
<span class="w">        </span><span class="n">Quote</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postQuote</span><span class="p">(</span><span class="n">r1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">CarType</span><span class="p">.</span><span class="na">SEDAN</span><span class="p">,</span><span class="w"> </span><span class="n">pickup</span><span class="p">,</span><span class="w"> </span><span class="n">drop</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;QUOTE -&gt; driver=&quot;</span><span class="o">+</span><span class="n">q</span><span class="p">.</span><span class="na">driverId</span><span class="o">+</span><span class="s">&quot; etaMin=&quot;</span><span class="o">+</span><span class="n">q</span><span class="p">.</span><span class="na">etaMin</span><span class="o">+</span><span class="s">&quot; fareEst=&quot;</span><span class="o">+</span><span class="n">q</span><span class="p">.</span><span class="na">fareEstimate</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Rider confirms</span>
<span class="w">        </span><span class="n">Ride</span><span class="w"> </span><span class="n">ride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postConfirm</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;CONFIRM -&gt; rideId=&quot;</span><span class="o">+</span><span class="n">ride</span><span class="p">.</span><span class="na">id</span><span class="o">+</span><span class="s">&quot; status=&quot;</span><span class="o">+</span><span class="n">ride</span><span class="p">.</span><span class="na">status</span><span class="p">);</span>

<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;TRACK pre-start -&gt; &quot;</span><span class="o">+</span><span class="n">api</span><span class="p">.</span><span class="na">getTrack</span><span class="p">(</span><span class="n">ride</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postStart</span><span class="p">(</span><span class="n">ride</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;START -&gt; status=&quot;</span><span class="o">+</span><span class="n">rideRepo</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">ride</span><span class="p">.</span><span class="na">id</span><span class="p">).</span><span class="na">get</span><span class="p">().</span><span class="na">status</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Simulate driving...</span>
<span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">putDriverLocation</span><span class="p">(</span><span class="n">ride</span><span class="p">.</span><span class="na">driverId</span><span class="p">,</span><span class="w"> </span><span class="mf">12.925</span><span class="p">,</span><span class="w"> </span><span class="mf">77.63</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;TRACK mid -&gt; &quot;</span><span class="o">+</span><span class="n">api</span><span class="p">.</span><span class="na">getTrack</span><span class="p">(</span><span class="n">ride</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// End ride</span>
<span class="w">        </span><span class="n">Ride</span><span class="w"> </span><span class="n">ended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postEnd</span><span class="p">(</span><span class="n">ride</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;END -&gt; fare=&quot;</span><span class="o">+</span><span class="n">ended</span><span class="p">.</span><span class="na">fare</span><span class="o">+</span><span class="s">&quot; status=&quot;</span><span class="o">+</span><span class="n">ended</span><span class="p">.</span><span class="na">status</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Payment</span>
<span class="w">        </span><span class="n">Payment</span><span class="w"> </span><span class="n">pay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postPayment</span><span class="p">(</span><span class="n">ride</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">ended</span><span class="p">.</span><span class="na">fare</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UPI&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TXN-7788&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;PAYMENT -&gt; &quot;</span><span class="o">+</span><span class="n">pay</span><span class="p">.</span><span class="na">status</span><span class="o">+</span><span class="s">&quot; amount=&quot;</span><span class="o">+</span><span class="n">pay</span><span class="p">.</span><span class="na">amount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="chat-app">Chat App<a class="headerlink" href="#chat-app" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>/*
Template -&gt;
1) define functional requirements
   - One-to-one and group chats.
   - Send/receive text messages; mark as delivered/read.
   - Fetch chat history with pagination (cursor/limit).
   - Maintain online/offline status.
   - Simple in-memory pub-sub style notifications (stub).
   - Lightweight, concurrency-safe where needed; doable in ~40 min.

2) define entities / actors
   Actors: User
   Entities: User, Chat (1-1 or group), Message, Participant, Presence

3) define apis - get/post/put, request, response
   POST   /users                        {name} -&gt; {userId}
   POST   /chats                        {creatorId, participantIds:[...], groupName?} -&gt; {chatId}
   POST   /chats/{chatId}/messages      {senderId, text} -&gt; {messageId, ts}
   GET    /chats/{chatId}/messages      {cursor?, limit} -&gt; [{messageId, senderId, text, ts, status}]
   PUT    /messages/{id}/delivered      {userId} -&gt; {ok}
   PUT    /messages/{id}/read           {userId} -&gt; {ok}
   PUT    /users/{id}/presence          {online} -&gt; {ok}

4) define services involved
   UserService       - create users, update presence.
   ChatService       - create chat, add participants.
   MessageService    - send messages, mark delivered/read.
   HistoryService    - fetch chat history with pagination.
   NotificationService- stub for notifying participants.
   IdGenerator       - generate IDs.

5) define db schema - what all tables are required, what are the columns, what are the keys
   user(id PK, name, online BOOL, created_at)
   chat(id PK, group_name NULL, is_group BOOL, created_at)
   chat_participant(chat_id FK, user_id FK, joined_at)
   message(id PK, chat_id FK, sender_id FK, text, created_at, status ENUM)
   message_status(message_id FK, user_id FK, delivered_at, read_at)
*/
</code></pre></div>
<h3 id="java-implementation_4">Java Implementation<a class="headerlink" href="#java-implementation_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">Template -&gt;</span>
<span class="cm">1) define functional requirements</span>
<span class="cm">   - One-to-one and group chats.</span>
<span class="cm">   - Send/receive text messages; mark as delivered/read.</span>
<span class="cm">   - Fetch chat history with pagination (cursor/limit).</span>
<span class="cm">   - Maintain online/offline status.</span>
<span class="cm">   - Simple in-memory pub-sub style notifications (stub).</span>
<span class="cm">   - Lightweight, concurrency-safe where needed; doable in ~40 min.</span>

<span class="cm">2) define entities / actors</span>
<span class="cm">   Actors: User</span>
<span class="cm">   Entities: User, Chat (1-1 or group), Message, Participant, Presence</span>

<span class="cm">3) define apis - get/post/put, request, response</span>
<span class="cm">   POST   /users                        {name} -&gt; {userId}</span>
<span class="cm">   POST   /chats                        {creatorId, participantIds:[...], groupName?} -&gt; {chatId}</span>
<span class="cm">   POST   /chats/{chatId}/messages      {senderId, text} -&gt; {messageId, ts}</span>
<span class="cm">   GET    /chats/{chatId}/messages      {cursor?, limit} -&gt; [{messageId, senderId, text, ts, status}]</span>
<span class="cm">   PUT    /messages/{id}/delivered      {userId} -&gt; {ok}</span>
<span class="cm">   PUT    /messages/{id}/read           {userId} -&gt; {ok}</span>
<span class="cm">   PUT    /users/{id}/presence          {online} -&gt; {ok}</span>

<span class="cm">4) define services involved</span>
<span class="cm">   UserService       - create users, update presence.</span>
<span class="cm">   ChatService       - create chat, add participants.</span>
<span class="cm">   MessageService    - send messages, mark delivered/read.</span>
<span class="cm">   HistoryService    - fetch chat history with pagination.</span>
<span class="cm">   NotificationService- stub for notifying participants.</span>
<span class="cm">   IdGenerator       - generate IDs.</span>

<span class="cm">5) define db schema - what all tables are required, what are the columns, what are the keys</span>
<span class="cm">   user(id PK, name, online BOOL, created_at)</span>
<span class="cm">   chat(id PK, group_name NULL, is_group BOOL, created_at)</span>
<span class="cm">   chat_participant(chat_id FK, user_id FK, joined_at)</span>
<span class="cm">   message(id PK, chat_id FK, sender_id FK, text, created_at, status ENUM)</span>
<span class="cm">   message_status(message_id FK, user_id FK, delivered_at, read_at)</span>
<span class="cm">*/</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="cm">/* ===== Domain ===== */</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">MessageStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">SENT</span><span class="p">,</span><span class="w"> </span><span class="n">DELIVERED</span><span class="p">,</span><span class="w"> </span><span class="n">READ</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">online</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">n</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">n</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Chat</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">groupName</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isGroup</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">participants</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="n">Chat</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="kt">boolean</span><span class="w"> </span><span class="n">isGroup</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">groupName</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">isGroup</span><span class="o">=</span><span class="n">isGroup</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">groupName</span><span class="o">=</span><span class="n">groupName</span><span class="p">;}</span>
<span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Message</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">chatId</span><span class="p">,</span><span class="w"> </span><span class="n">senderId</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">MessageStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">perUser</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">// userId -&gt; status</span>
<span class="w">    </span><span class="n">Message</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">chatId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">senderId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">chatId</span><span class="o">=</span><span class="n">chatId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">senderId</span><span class="o">=</span><span class="n">senderId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">text</span><span class="o">=</span><span class="n">text</span><span class="p">;}</span>
<span class="p">}</span>

<span class="cm">/* ===== Utils ===== */</span>
<span class="kd">class</span> <span class="nc">Ids</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">n</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">();}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Repos ===== */</span>
<span class="kd">class</span> <span class="nc">UserRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">u</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">u</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">u</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">ChatRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Chat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Chat</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Chat</span><span class="w"> </span><span class="n">c</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">c</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Chat</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">MsgRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byChat</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">chatId</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="na">chatId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">chatId</span><span class="p">)).</span><span class="na">sorted</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparing</span><span class="p">((</span><span class="n">Message</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="na">createdAt</span><span class="p">)).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Services ===== */</span>
<span class="kd">class</span> <span class="nc">UserService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">UserRepo</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">UserService</span><span class="p">(</span><span class="n">UserRepo</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">users</span><span class="o">=</span><span class="n">u</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>
<span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;u&quot;</span><span class="p">),</span><span class="n">name</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setPresence</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">online</span><span class="p">){</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">id</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="na">online</span><span class="o">=</span><span class="n">online</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">ChatService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ChatRepo</span><span class="w"> </span><span class="n">chats</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">UserRepo</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">ChatService</span><span class="p">(</span><span class="n">ChatRepo</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="n">UserRepo</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">chats</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="n">users</span><span class="o">=</span><span class="n">u</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Chat</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">creatorId</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parts</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isGroup</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">groupName</span><span class="p">){</span>
<span class="w">        </span><span class="n">Chat</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Chat</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;chat&quot;</span><span class="p">),</span><span class="n">isGroup</span><span class="p">,</span><span class="n">groupName</span><span class="p">);</span>
<span class="w">        </span><span class="n">c</span><span class="p">.</span><span class="na">participants</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">creatorId</span><span class="p">);</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">participants</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">parts</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">chats</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MessageService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MsgRepo</span><span class="w"> </span><span class="n">msgs</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ChatRepo</span><span class="w"> </span><span class="n">chats</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">MessageService</span><span class="p">(</span><span class="n">MsgRepo</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="n">ChatRepo</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">msgs</span><span class="o">=</span><span class="n">m</span><span class="p">;</span><span class="n">chats</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Message</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">chatId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">senderId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="p">){</span>
<span class="w">        </span><span class="n">Chat</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">chats</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">chatId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;chat not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">.</span><span class="na">participants</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">senderId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;not in chat&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Message</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">),</span><span class="n">chatId</span><span class="p">,</span><span class="n">senderId</span><span class="p">,</span><span class="n">text</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">uid</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="na">participants</span><span class="p">){</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">perUser</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">senderId</span><span class="p">)</span><span class="o">?</span><span class="n">MessageStatus</span><span class="p">.</span><span class="na">READ</span><span class="p">:</span><span class="n">MessageStatus</span><span class="p">.</span><span class="na">SENT</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">msgs</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">delivered</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msgId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="n">msgs</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">msgId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">perUser</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="n">MessageStatus</span><span class="p">.</span><span class="na">DELIVERED</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msgId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="n">msgs</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">msgId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">perUser</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="n">MessageStatus</span><span class="p">.</span><span class="na">READ</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">HistoryService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MsgRepo</span><span class="w"> </span><span class="n">msgs</span><span class="p">;</span>
<span class="w">    </span><span class="n">HistoryService</span><span class="p">(</span><span class="n">MsgRepo</span><span class="w"> </span><span class="n">m</span><span class="p">){</span><span class="n">msgs</span><span class="o">=</span><span class="n">m</span><span class="p">;}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getHistory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">chatId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cursor</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">){</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">all</span><span class="o">=</span><span class="n">msgs</span><span class="p">.</span><span class="na">byChat</span><span class="p">(</span><span class="n">chatId</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">cursor</span><span class="o">!=</span><span class="kc">null</span><span class="p">){</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">all</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">all</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">id</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">cursor</span><span class="p">)){</span><span class="w"> </span><span class="n">start</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">all</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">skip</span><span class="p">(</span><span class="n">start</span><span class="p">).</span><span class="na">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Controller ===== */</span>
<span class="kd">class</span> <span class="nc">ChatController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ChatService</span><span class="w"> </span><span class="n">chats</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MessageService</span><span class="w"> </span><span class="n">msgs</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">HistoryService</span><span class="w"> </span><span class="n">history</span><span class="p">;</span>
<span class="w">    </span><span class="n">ChatController</span><span class="p">(</span><span class="n">UserService</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="n">ChatService</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="n">MessageService</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="n">HistoryService</span><span class="w"> </span><span class="n">h</span><span class="p">){</span><span class="n">users</span><span class="o">=</span><span class="n">u</span><span class="p">;</span><span class="n">chats</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="n">msgs</span><span class="o">=</span><span class="n">m</span><span class="p">;</span><span class="n">history</span><span class="o">=</span><span class="n">h</span><span class="p">;}</span>

<span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">postUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">putPresence</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">online</span><span class="p">){</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">setPresence</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">online</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">Chat</span><span class="w"> </span><span class="nf">postChat</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">creatorId</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parts</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isGroup</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">groupName</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">chats</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">creatorId</span><span class="p">,</span><span class="n">parts</span><span class="p">,</span><span class="n">isGroup</span><span class="p">,</span><span class="n">groupName</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">Message</span><span class="w"> </span><span class="nf">postMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">chatId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">senderId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">msgs</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">chatId</span><span class="p">,</span><span class="n">senderId</span><span class="p">,</span><span class="n">text</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">putDelivered</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msgId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="n">msgs</span><span class="p">.</span><span class="na">delivered</span><span class="p">(</span><span class="n">msgId</span><span class="p">,</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">putRead</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msgId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="n">msgs</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">msgId</span><span class="p">,</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getHistory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">chatId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">cursor</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">history</span><span class="p">.</span><span class="na">getHistory</span><span class="p">(</span><span class="n">chatId</span><span class="p">,</span><span class="n">cursor</span><span class="p">,</span><span class="n">limit</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Demo ===== */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WhatsApp40Min</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Ids</span><span class="p">();</span><span class="w"> </span><span class="n">UserRepo</span><span class="w"> </span><span class="n">userRepo</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">UserRepo</span><span class="p">();</span><span class="w"> </span><span class="n">ChatRepo</span><span class="w"> </span><span class="n">chatRepo</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ChatRepo</span><span class="p">();</span><span class="w"> </span><span class="n">MsgRepo</span><span class="w"> </span><span class="n">msgRepo</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">MsgRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">UserService</span><span class="w"> </span><span class="n">userSvc</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">UserService</span><span class="p">(</span><span class="n">userRepo</span><span class="p">,</span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">ChatService</span><span class="w"> </span><span class="n">chatSvc</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ChatService</span><span class="p">(</span><span class="n">chatRepo</span><span class="p">,</span><span class="n">userRepo</span><span class="p">,</span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">MessageService</span><span class="w"> </span><span class="n">msgSvc</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">MessageService</span><span class="p">(</span><span class="n">msgRepo</span><span class="p">,</span><span class="n">chatRepo</span><span class="p">,</span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">HistoryService</span><span class="w"> </span><span class="n">histSvc</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">HistoryService</span><span class="p">(</span><span class="n">msgRepo</span><span class="p">);</span>
<span class="w">        </span><span class="n">ChatController</span><span class="w"> </span><span class="n">api</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ChatController</span><span class="p">(</span><span class="n">userSvc</span><span class="p">,</span><span class="n">chatSvc</span><span class="p">,</span><span class="n">msgSvc</span><span class="p">,</span><span class="n">histSvc</span><span class="p">);</span>

<span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="n">api</span><span class="p">.</span><span class="na">postUser</span><span class="p">(</span><span class="s">&quot;Alice&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="n">api</span><span class="p">.</span><span class="na">postUser</span><span class="p">(</span><span class="s">&quot;Bob&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">putPresence</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">putPresence</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>

<span class="w">        </span><span class="n">Chat</span><span class="w"> </span><span class="n">chat</span><span class="o">=</span><span class="n">api</span><span class="p">.</span><span class="na">postChat</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">Set</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">id</span><span class="p">),</span><span class="kc">false</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Chat created: &quot;</span><span class="o">+</span><span class="n">chat</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>

<span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">m1</span><span class="o">=</span><span class="n">api</span><span class="p">.</span><span class="na">postMessage</span><span class="p">(</span><span class="n">chat</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">a</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="s">&quot;Hi Bob!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">m2</span><span class="o">=</span><span class="n">api</span><span class="p">.</span><span class="na">postMessage</span><span class="p">(</span><span class="n">chat</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">b</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="s">&quot;Hey Alice!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">putDelivered</span><span class="p">(</span><span class="n">m1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">b</span><span class="p">.</span><span class="na">id</span><span class="p">);</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">putRead</span><span class="p">(</span><span class="n">m1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">b</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>

<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;History: &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">m</span><span class="p">:</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getHistory</span><span class="p">(</span><span class="n">chat</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="mi">10</span><span class="p">)){</span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">id</span><span class="o">+</span><span class="s">&quot; from &quot;</span><span class="o">+</span><span class="n">m</span><span class="p">.</span><span class="na">senderId</span><span class="o">+</span><span class="s">&quot;: &quot;</span><span class="o">+</span><span class="n">m</span><span class="p">.</span><span class="na">text</span><span class="o">+</span><span class="s">&quot; statuses=&quot;</span><span class="o">+</span><span class="n">m</span><span class="p">.</span><span class="na">perUser</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="file-store">File Store<a class="headerlink" href="#file-store" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>/*
Template -&gt;
1) define functional requirements
   - Create folders/files; hierarchical tree with root per user.
   - Upload file (new file or new version), download (stub returns bytes length), rename, move, delete (trash) &amp; restore.
   - Share file/folder with users with permissions: VIEW, EDIT, OWNER (owner implicit).
   - List folder contents with pagination (cursor+limit).
   - Search by name (prefix/substring) within items user can access.
   - Version history: list versions, restore a previous version.
   - In-memory only; 40-min interview friendly; single JVM; basic concurrency safety.

2) define entities / actors
   Actors: User
   Entities: User, Node(abstract), Folder, FileNode, FileVersion, ShareEntry, TrashEntry

3) define apis - get/post/put, request, response (mirrored by controller methods)
   POST   /users                                   {name} -&gt; {userId}
   POST   /nodes/folder                            {ownerId, parentId, name} -&gt; {folderId}
   POST   /nodes/file                              {ownerId, parentId, name, bytes[]} -&gt; {fileId, versionId}
   POST   /nodes/file/{fileId}/versions            {ownerId, bytes[]} -&gt; {versionId}
   GET    /nodes/{nodeId}                          -&gt; {metadata}
   GET    /nodes/{folderId}/children               {cursor?, limit} -&gt; {items[], nextCursor?}
   GET    /download/{fileId}/latest                -&gt; {bytesLength, versionId}
   POST   /share                                   {nodeId, granteeUserId, perm(VIEW|EDIT)} -&gt; {ok}
   GET    /search                                  {userId, query} -&gt; {nodes[]}
   PUT    /nodes/{nodeId}/rename                   {name} -&gt; {ok}
   PUT    /nodes/{nodeId}/move                     {newParentId} -&gt; {ok}
   DELETE /nodes/{nodeId}                          -&gt; {trashed=true}
   POST   /trash/{nodeId}/restore                  -&gt; {ok}
   GET    /files/{fileId}/versions                 -&gt; [{versionId, size, createdAt}]
   POST   /files/{fileId}/restoreVersion           {versionId} -&gt; {ok}

4) define services involved
   AuthZService        - permission checks (OWNER/EDIT/VIEW), inheritance on folders.
   TreeService         - create/move/rename/list; trash/restore; path integrity.
   FileService         - upload versions, download, version list/restore.
   ShareService        - grant/revoke sharing on nodes (propagates by traversal).
   SearchService       - simple name-based search filtered by access.
   IdGenerator         - IDs.

5) define db schema - what all tables are required, what are the columns, what are the keys
   user(id PK, name, created_at)
   node(id PK, type ENUM(FILE,FOLDER), name, owner_id FK(user), parent_id FK(node), created_at, updated_at, trashed BOOL)
   file_version(id PK, file_id FK(node), size, created_at, data BLOB)   // in prod, data in object store
   share(node_id FK, grantee_user_id FK(user), perm ENUM(VIEW,EDIT), created_at)  UNIQUE(node_id, grantee_user_id)
   // effective permission = owner OR explicit share OR inherited from any ancestor folder
*/
</code></pre></div>
<h3 id="java-implementation_5">Java Implementation<a class="headerlink" href="#java-implementation_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">Template -&gt;</span>
<span class="cm">1) define functional requirements</span>
<span class="cm">   - Create folders/files; hierarchical tree with root per user.</span>
<span class="cm">   - Upload file (new file or new version), download (stub returns bytes length), rename, move, delete (trash) &amp; restore.</span>
<span class="cm">   - Share file/folder with users with permissions: VIEW, EDIT, OWNER (owner implicit).</span>
<span class="cm">   - List folder contents with pagination (cursor+limit).</span>
<span class="cm">   - Search by name (prefix/substring) within items user can access.</span>
<span class="cm">   - Version history: list versions, restore a previous version.</span>
<span class="cm">   - In-memory only; 40-min interview friendly; single JVM; basic concurrency safety.</span>

<span class="cm">2) define entities / actors</span>
<span class="cm">   Actors: User</span>
<span class="cm">   Entities: User, Node(abstract), Folder, FileNode, FileVersion, ShareEntry, TrashEntry</span>

<span class="cm">3) define apis - get/post/put, request, response (mirrored by controller methods)</span>
<span class="cm">   POST   /users                                   {name} -&gt; {userId}</span>
<span class="cm">   POST   /nodes/folder                            {ownerId, parentId, name} -&gt; {folderId}</span>
<span class="cm">   POST   /nodes/file                              {ownerId, parentId, name, bytes[]} -&gt; {fileId, versionId}</span>
<span class="cm">   POST   /nodes/file/{fileId}/versions            {ownerId, bytes[]} -&gt; {versionId}</span>
<span class="cm">   GET    /nodes/{nodeId}                          -&gt; {metadata}</span>
<span class="cm">   GET    /nodes/{folderId}/children               {cursor?, limit} -&gt; {items[], nextCursor?}</span>
<span class="cm">   GET    /download/{fileId}/latest                -&gt; {bytesLength, versionId}</span>
<span class="cm">   POST   /share                                   {nodeId, granteeUserId, perm(VIEW|EDIT)} -&gt; {ok}</span>
<span class="cm">   GET    /search                                  {userId, query} -&gt; {nodes[]}</span>
<span class="cm">   PUT    /nodes/{nodeId}/rename                   {name} -&gt; {ok}</span>
<span class="cm">   PUT    /nodes/{nodeId}/move                     {newParentId} -&gt; {ok}</span>
<span class="cm">   DELETE /nodes/{nodeId}                          -&gt; {trashed=true}</span>
<span class="cm">   POST   /trash/{nodeId}/restore                  -&gt; {ok}</span>
<span class="cm">   GET    /files/{fileId}/versions                 -&gt; [{versionId, size, createdAt}]</span>
<span class="cm">   POST   /files/{fileId}/restoreVersion           {versionId} -&gt; {ok}</span>

<span class="cm">4) define services involved</span>
<span class="cm">   AuthZService        - permission checks (OWNER/EDIT/VIEW), inheritance on folders.</span>
<span class="cm">   TreeService         - create/move/rename/list; trash/restore; path integrity.</span>
<span class="cm">   FileService         - upload versions, download, version list/restore.</span>
<span class="cm">   ShareService        - grant/revoke sharing on nodes (propagates by traversal).</span>
<span class="cm">   SearchService       - simple name-based search filtered by access.</span>
<span class="cm">   IdGenerator         - IDs.</span>

<span class="cm">5) define db schema - what all tables are required, what are the columns, what are the keys</span>
<span class="cm">   user(id PK, name, created_at)</span>
<span class="cm">   node(id PK, type ENUM(FILE,FOLDER), name, owner_id FK(user), parent_id FK(node), created_at, updated_at, trashed BOOL)</span>
<span class="cm">   file_version(id PK, file_id FK(node), size, created_at, data BLOB)   // in prod, data in object store</span>
<span class="cm">   share(node_id FK, grantee_user_id FK(user), perm ENUM(VIEW,EDIT), created_at)  UNIQUE(node_id, grantee_user_id)</span>
<span class="cm">   // effective permission = owner OR explicit share OR inherited from any ancestor folder</span>
<span class="cm">*/</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="cm">/* ===== Domain ===== */</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">NodeType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FILE</span><span class="p">,</span><span class="w"> </span><span class="n">FOLDER</span><span class="w"> </span><span class="p">}</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">Perm</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">VIEW</span><span class="p">,</span><span class="w"> </span><span class="n">EDIT</span><span class="p">,</span><span class="w"> </span><span class="n">OWNER</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">name</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/** Abstract Node */</span>
<span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ownerId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">;</span><span class="w"> </span><span class="c1">// null for root</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">NodeType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">trashed</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">(),</span><span class="w"> </span><span class="n">updatedAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="n">Node</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">NodeType</span><span class="w"> </span><span class="n">type</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">ownerId</span><span class="o">=</span><span class="n">ownerId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">parentId</span><span class="o">=</span><span class="n">parentId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">type</span><span class="o">=</span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Folder</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Folder</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span><span class="w"> </span><span class="kd">super</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">ownerId</span><span class="p">,</span><span class="n">parentId</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">NodeType</span><span class="p">.</span><span class="na">FOLDER</span><span class="p">);}</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FileVersion</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="n">FileVersion</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">fileId</span><span class="o">=</span><span class="n">fileId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">data</span><span class="o">=</span><span class="n">data</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">size</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="na">length</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FileNode</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// versions newest-first at index 0</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FileVersion</span><span class="o">&gt;</span><span class="w"> </span><span class="n">versions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">synchronizedList</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">());</span>
<span class="w">    </span><span class="n">FileNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span><span class="w"> </span><span class="kd">super</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">ownerId</span><span class="p">,</span><span class="n">parentId</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">NodeType</span><span class="p">.</span><span class="na">FILE</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ShareEntry</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">granteeUserId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Perm</span><span class="w"> </span><span class="n">perm</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="n">ShareEntry</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">granteeUserId</span><span class="p">,</span><span class="n">Perm</span><span class="w"> </span><span class="n">perm</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">nodeId</span><span class="o">=</span><span class="n">nodeId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">granteeUserId</span><span class="o">=</span><span class="n">granteeUserId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">perm</span><span class="o">=</span><span class="n">perm</span><span class="p">;}</span>
<span class="p">}</span>

<span class="cm">/* ===== Ids ===== */</span>
<span class="kd">class</span> <span class="nc">Ids</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">n</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Repos (in-memory) ===== */</span>
<span class="kd">class</span> <span class="nc">UserRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">u</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">u</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">u</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">NodeRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="p">){</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="na">updatedAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">n</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">children</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="na">parentId</span><span class="p">,</span><span class="n">parentId</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">sorted</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparing</span><span class="p">((</span><span class="n">Node</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="na">type</span><span class="p">).</span><span class="na">thenComparing</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="na">name</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">()))</span>
<span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">VersionRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">FileVersion</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">FileVersion</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">FileVersion</span><span class="w"> </span><span class="n">v</span><span class="p">){</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">v</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">FileVersion</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">ShareRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// key: nodeId -&gt; (userId -&gt; perm)</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ShareEntry</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">upsert</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Perm</span><span class="w"> </span><span class="n">perm</span><span class="p">){</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">nodeId</span><span class="p">,</span><span class="n">k</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">()).</span><span class="na">put</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ShareEntry</span><span class="p">(</span><span class="n">nodeId</span><span class="p">,</span><span class="n">userId</span><span class="p">,</span><span class="n">perm</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">ShareEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">()).</span><span class="na">get</span><span class="p">(</span><span class="n">userId</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">ShareEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">forNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Exceptions ===== */</span>
<span class="kd">class</span> <span class="nc">DomainException</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">RuntimeException</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="p">){</span><span class="kd">super</span><span class="p">(</span><span class="n">msg</span><span class="p">);}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Services ===== */</span>
<span class="kd">class</span> <span class="nc">AuthZService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ShareRepo</span><span class="w"> </span><span class="n">shares</span><span class="p">;</span>
<span class="w">    </span><span class="n">AuthZService</span><span class="p">(</span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">ShareRepo</span><span class="w"> </span><span class="n">s</span><span class="p">){</span><span class="n">nodes</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">shares</span><span class="o">=</span><span class="n">s</span><span class="p">;}</span>

<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canView</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">hasPerm</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="n">nodeId</span><span class="p">,</span><span class="n">Perm</span><span class="p">.</span><span class="na">VIEW</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canEdit</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">hasPerm</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="n">nodeId</span><span class="p">,</span><span class="n">Perm</span><span class="p">.</span><span class="na">EDIT</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">hasPerm</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Perm</span><span class="w"> </span><span class="n">needed</span><span class="p">){</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;node&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// owner is OWNER</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// explicit share</span>
<span class="w">        </span><span class="n">Perm</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxPermOnNode</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permSatisfies</span><span class="p">(</span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="n">needed</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// inherited from ancestors</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">parentId</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span>
<span class="w">            </span><span class="n">Node</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">pid</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxPermOnNode</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permSatisfies</span><span class="p">(</span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="n">needed</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="na">parentId</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Perm</span><span class="w"> </span><span class="nf">maxPermOnNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shares</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">nodeId</span><span class="p">,</span><span class="n">userId</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="na">perm</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">permSatisfies</span><span class="p">(</span><span class="n">Perm</span><span class="w"> </span><span class="n">have</span><span class="p">,</span><span class="w"> </span><span class="n">Perm</span><span class="w"> </span><span class="n">needed</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">have</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">have</span><span class="o">==</span><span class="n">Perm</span><span class="p">.</span><span class="na">OWNER</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needed</span><span class="o">==</span><span class="n">Perm</span><span class="p">.</span><span class="na">VIEW</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">have</span><span class="o">==</span><span class="n">Perm</span><span class="p">.</span><span class="na">VIEW</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">have</span><span class="o">==</span><span class="n">Perm</span><span class="p">.</span><span class="na">EDIT</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needed</span><span class="o">==</span><span class="n">Perm</span><span class="p">.</span><span class="na">EDIT</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">have</span><span class="o">==</span><span class="n">Perm</span><span class="p">.</span><span class="na">EDIT</span><span class="p">;</span><span class="w"> </span><span class="c1">// OWNER already handled</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">TreeService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">TreeService</span><span class="p">(</span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">nodes</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Folder</span><span class="w"> </span><span class="nf">createFolder</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span>
<span class="w">        </span><span class="n">validateParent</span><span class="p">(</span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">ownerId</span><span class="p">);</span>
<span class="w">        </span><span class="n">Folder</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Folder</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;fld&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">Folder</span><span class="p">)</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">FileNode</span><span class="w"> </span><span class="nf">createFile</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">VersionRepo</span><span class="w"> </span><span class="n">versions</span><span class="p">){</span>
<span class="w">        </span><span class="n">validateParent</span><span class="p">(</span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">ownerId</span><span class="p">);</span>
<span class="w">        </span><span class="n">FileNode</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileNode</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;fil&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="n">nodes</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// first version</span>
<span class="w">        </span><span class="n">FileVersion</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileVersion</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;ver&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">fn</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="n">versions</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="w">        </span><span class="n">fn</span><span class="p">.</span><span class="na">versions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">FileNode</span><span class="p">)</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">rename</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">newName</span><span class="p">){</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;node&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">.</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;only owner can rename (simplified)&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">n</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newName</span><span class="p">;</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">move</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">newParentId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;node&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newParentId</span><span class="o">==</span><span class="kc">null</span><span class="o">?</span><span class="kc">null</span><span class="p">:</span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">newParentId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;parent&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">!=</span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">type</span><span class="o">!=</span><span class="n">NodeType</span><span class="p">.</span><span class="na">FOLDER</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;parent must be folder&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">.</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;only owner can move (simplified)&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// prevent cycles</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isDescendant</span><span class="p">(</span><span class="n">newParentId</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="na">id</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;cannot move into descendant&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">n</span><span class="p">.</span><span class="na">parentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newParentId</span><span class="p">;</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">trash</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;node&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">.</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;only owner can trash&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">markTrashedRecursive</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">restore</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;node&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">.</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;only owner can restore&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">markTrashedRecursive</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">listChildren</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">folderId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cursor</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">){</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">folderId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;folder&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="na">type</span><span class="o">!=</span><span class="n">NodeType</span><span class="p">.</span><span class="na">FOLDER</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;not folder&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">children</span><span class="p">(</span><span class="n">folderId</span><span class="p">).</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;!</span><span class="n">n</span><span class="p">.</span><span class="na">trashed</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cursor</span><span class="o">!=</span><span class="kc">null</span><span class="p">){</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">all</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">all</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">id</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">cursor</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">all</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">skip</span><span class="p">(</span><span class="n">start</span><span class="p">).</span><span class="na">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">validateParent</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parentId</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">parentId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;parent not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">type</span><span class="o">!=</span><span class="n">NodeType</span><span class="p">.</span><span class="na">FOLDER</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;parent must be a folder&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">.</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">ownerId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;parent not owned by creator (simplified)&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDescendant</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">candidateParentId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">candidateParentId</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">!=</span><span class="kc">null</span><span class="p">){</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">nodeId</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">cur</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">            </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">==</span><span class="kc">null</span><span class="o">?</span><span class="kc">null</span><span class="p">:</span><span class="n">n</span><span class="p">.</span><span class="na">parentId</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">markTrashedRecursive</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">val</span><span class="p">){</span>
<span class="w">        </span><span class="n">n</span><span class="p">.</span><span class="na">trashed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="na">type</span><span class="o">==</span><span class="n">NodeType</span><span class="p">.</span><span class="na">FOLDER</span><span class="p">){</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">children</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="na">id</span><span class="p">))</span><span class="w"> </span><span class="n">markTrashedRecursive</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">FileService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">VersionRepo</span><span class="w"> </span><span class="n">versions</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">FileService</span><span class="p">(</span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">VersionRepo</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">nodes</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">versions</span><span class="o">=</span><span class="n">v</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>

<span class="w">    </span><span class="n">FileVersion</span><span class="w"> </span><span class="nf">uploadNewVersion</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">){</span>
<span class="w">        </span><span class="n">FileNode</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FileNode</span><span class="p">)</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">fileId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">.</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;only owner can upload version (simplified)&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">FileVersion</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileVersion</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;ver&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="n">versions</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="na">versions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>
<span class="w">        </span><span class="n">nodes</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FileVersion</span><span class="w"> </span><span class="nf">downloadLatest</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">){</span>
<span class="w">        </span><span class="n">FileNode</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FileNode</span><span class="p">)</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">fileId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="na">versions</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no versions&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="na">versions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FileVersion</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">listVersions</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">){</span>
<span class="w">        </span><span class="n">FileNode</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FileNode</span><span class="p">)</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">fileId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="na">versions</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">restoreVersion</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">versionId</span><span class="p">){</span>
<span class="w">        </span><span class="n">FileNode</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FileNode</span><span class="p">)</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">fileId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">.</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;only owner can restore&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">FileVersion</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">versions</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">versionId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">.</span><span class="na">fileId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="na">id</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;version/file mismatch&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// move this version to head by inserting a clone (typical GDrive restore creates new head)</span>
<span class="w">        </span><span class="n">FileVersion</span><span class="w"> </span><span class="n">restored</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileVersion</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;ver&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="na">data</span><span class="p">);</span>
<span class="w">        </span><span class="n">versions</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">restored</span><span class="p">);</span>
<span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="na">versions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">restored</span><span class="p">);</span>
<span class="w">        </span><span class="n">nodes</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">ShareService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ShareRepo</span><span class="w"> </span><span class="n">shares</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span>
<span class="w">    </span><span class="n">ShareService</span><span class="p">(</span><span class="n">ShareRepo</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">n</span><span class="p">){</span><span class="n">shares</span><span class="o">=</span><span class="n">s</span><span class="p">;</span><span class="w"> </span><span class="n">nodes</span><span class="o">=</span><span class="n">n</span><span class="p">;}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">share</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">granteeUserId</span><span class="p">,</span><span class="w"> </span><span class="n">Perm</span><span class="w"> </span><span class="n">perm</span><span class="p">){</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;node&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">.</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">ownerId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;only owner can share (simplified)&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">perm</span><span class="o">==</span><span class="n">Perm</span><span class="p">.</span><span class="na">OWNER</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;cannot grant OWNER&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">shares</span><span class="p">.</span><span class="na">upsert</span><span class="p">(</span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">granteeUserId</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">SearchService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AuthZService</span><span class="w"> </span><span class="n">authz</span><span class="p">;</span>
<span class="w">    </span><span class="n">SearchService</span><span class="p">(</span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">AuthZService</span><span class="w"> </span><span class="n">a</span><span class="p">){</span><span class="n">nodes</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">authz</span><span class="o">=</span><span class="n">a</span><span class="p">;}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">query</span><span class="p">){</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">query</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;!</span><span class="n">n</span><span class="p">.</span><span class="na">trashed</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="na">name</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">authz</span><span class="p">.</span><span class="na">canView</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="na">id</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">sorted</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparing</span><span class="p">((</span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="na">type</span><span class="p">).</span><span class="na">thenComparing</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="na">name</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">()))</span>
<span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Controller Facade ===== */</span>
<span class="kd">class</span> <span class="nc">DriveController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">UserRepo</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">VersionRepo</span><span class="w"> </span><span class="n">versions</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AuthZService</span><span class="w"> </span><span class="n">authz</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TreeService</span><span class="w"> </span><span class="n">tree</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FileService</span><span class="w"> </span><span class="n">fileSvc</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ShareService</span><span class="w"> </span><span class="n">share</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SearchService</span><span class="w"> </span><span class="n">search</span><span class="p">;</span>

<span class="w">    </span><span class="n">DriveController</span><span class="p">(</span><span class="n">UserRepo</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">VersionRepo</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">AuthZService</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">TreeService</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">FileService</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">ShareService</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">SearchService</span><span class="w"> </span><span class="n">srch</span><span class="p">){</span>
<span class="w">        </span><span class="n">users</span><span class="o">=</span><span class="n">u</span><span class="p">;</span><span class="w"> </span><span class="n">nodes</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">versions</span><span class="o">=</span><span class="n">v</span><span class="p">;</span><span class="w"> </span><span class="n">authz</span><span class="o">=</span><span class="n">a</span><span class="p">;</span><span class="w"> </span><span class="n">tree</span><span class="o">=</span><span class="n">t</span><span class="p">;</span><span class="w"> </span><span class="n">fileSvc</span><span class="o">=</span><span class="n">f</span><span class="p">;</span><span class="w"> </span><span class="n">share</span><span class="o">=</span><span class="n">s</span><span class="p">;</span><span class="w"> </span><span class="n">search</span><span class="o">=</span><span class="n">srch</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">postUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">GDrive40Min</span><span class="p">.</span><span class="na">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;u&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">name</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">Folder</span><span class="w"> </span><span class="nf">postFolder</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">tree</span><span class="p">.</span><span class="na">createFolder</span><span class="p">(</span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">FileNode</span><span class="w"> </span><span class="nf">postFile</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">tree</span><span class="p">.</span><span class="na">createFile</span><span class="p">(</span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">parentId</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">versions</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">FileVersion</span><span class="w"> </span><span class="nf">postFileVersion</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authz</span><span class="p">.</span><span class="na">canEdit</span><span class="p">(</span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no edit permission&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fileSvc</span><span class="p">.</span><span class="na">uploadNewVersion</span><span class="p">(</span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authz</span><span class="p">.</span><span class="na">canView</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">nodeId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no view permission&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;node&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="na">id</span><span class="p">);</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="na">type</span><span class="p">.</span><span class="na">name</span><span class="p">());</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="na">name</span><span class="p">);</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;ownerId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="na">ownerId</span><span class="p">);</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;parentId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="na">parentId</span><span class="p">);</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;trashed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="na">trashed</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getChildren</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">folderId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cursor</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authz</span><span class="p">.</span><span class="na">canView</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">folderId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no view permission&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree</span><span class="p">.</span><span class="na">listChildren</span><span class="p">(</span><span class="n">folderId</span><span class="p">,</span><span class="w"> </span><span class="n">cursor</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">items</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">==</span><span class="n">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">items</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">items</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="na">id</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">items</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="s">&quot;name&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">.</span><span class="na">name</span><span class="p">,</span><span class="s">&quot;type&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">.</span><span class="na">type</span><span class="p">.</span><span class="na">name</span><span class="p">())).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">()));</span>
<span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;nextCursor&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getDownloadLatest</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authz</span><span class="p">.</span><span class="na">canView</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no view permission&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">FileVersion</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fileSvc</span><span class="p">.</span><span class="na">downloadLatest</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;versionId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bytesLength&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="na">size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">putRename</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">newName</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authz</span><span class="p">.</span><span class="na">canEdit</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">nodeId</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">().</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no edit permission&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tree</span><span class="p">.</span><span class="na">rename</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">newName</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">putMove</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">newParentId</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">().</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;only owner can move&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tree</span><span class="p">.</span><span class="na">move</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">newParentId</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">deleteNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">nodes</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">().</span><span class="na">ownerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;only owner can trash&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tree</span><span class="p">.</span><span class="na">trash</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">nodeId</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">postRestore</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">){</span><span class="w"> </span><span class="n">tree</span><span class="p">.</span><span class="na">restore</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">nodeId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">postShare</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">granteeUserId</span><span class="p">,</span><span class="w"> </span><span class="n">Perm</span><span class="w"> </span><span class="n">perm</span><span class="p">){</span><span class="w"> </span><span class="n">share</span><span class="p">.</span><span class="na">share</span><span class="p">(</span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">granteeUserId</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getSearch</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">query</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">search</span><span class="p">.</span><span class="na">search</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getVersions</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authz</span><span class="p">.</span><span class="na">canView</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no view permission&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fileSvc</span><span class="p">.</span><span class="na">listVersions</span><span class="p">(</span><span class="n">fileId</span><span class="p">).</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;versionId&quot;</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="s">&quot;size&quot;</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="na">size</span><span class="p">,</span><span class="s">&quot;createdAt&quot;</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="na">createdAt</span><span class="p">)).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">postRestoreVersion</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">versionId</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authz</span><span class="p">.</span><span class="na">canEdit</span><span class="p">(</span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DomainException</span><span class="p">(</span><span class="s">&quot;no edit permission&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">fileSvc</span><span class="p">.</span><span class="na">restoreVersion</span><span class="p">(</span><span class="n">ownerId</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="n">versionId</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Demo (tiny, 40-min friendly) ===== */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GDrive40Min</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ids</span><span class="p">();</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Repos</span>
<span class="w">        </span><span class="n">UserRepo</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">NodeRepo</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NodeRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">VersionRepo</span><span class="w"> </span><span class="n">versions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VersionRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">ShareRepo</span><span class="w"> </span><span class="n">shares</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ShareRepo</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Services</span>
<span class="w">        </span><span class="n">AuthZService</span><span class="w"> </span><span class="n">authz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AuthZService</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="n">shares</span><span class="p">);</span>
<span class="w">        </span><span class="n">TreeService</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeService</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">FileService</span><span class="w"> </span><span class="n">fileSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileService</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="n">versions</span><span class="p">,</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">ShareService</span><span class="w"> </span><span class="n">shareSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ShareService</span><span class="p">(</span><span class="n">shares</span><span class="p">,</span><span class="w"> </span><span class="n">nodes</span><span class="p">);</span>
<span class="w">        </span><span class="n">SearchService</span><span class="w"> </span><span class="n">searchSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SearchService</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="n">authz</span><span class="p">);</span>

<span class="w">        </span><span class="n">DriveController</span><span class="w"> </span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DriveController</span><span class="p">(</span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="n">versions</span><span class="p">,</span><span class="w"> </span><span class="n">authz</span><span class="p">,</span><span class="w"> </span><span class="n">tree</span><span class="p">,</span><span class="w"> </span><span class="n">fileSvc</span><span class="p">,</span><span class="w"> </span><span class="n">shareSvc</span><span class="p">,</span><span class="w"> </span><span class="n">searchSvc</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Users</span>
<span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">alice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postUser</span><span class="p">(</span><span class="s">&quot;Alice&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">bob</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postUser</span><span class="p">(</span><span class="s">&quot;Bob&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Root (null parent) and basic structure for Alice</span>
<span class="w">        </span><span class="n">Folder</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postFolder</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Alice Root&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Folder</span><span class="w"> </span><span class="n">docs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postFolder</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Docs&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Folder</span><span class="w"> </span><span class="n">pics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postFolder</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Pictures&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Upload a file</span>
<span class="w">        </span><span class="n">FileNode</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postFile</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">docs</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;DesignSpec.md&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;v1 design&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Uploaded file: &quot;</span><span class="o">+</span><span class="n">spec</span><span class="p">.</span><span class="na">id</span><span class="o">+</span><span class="s">&quot; latest=&quot;</span><span class="o">+</span><span class="n">api</span><span class="p">.</span><span class="na">getDownloadLatest</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// New version</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postFileVersion</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;v2 design (added API)&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Versions: &quot;</span><span class="o">+</span><span class="n">api</span><span class="p">.</span><span class="na">getVersions</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Share with Bob as VIEW</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postShare</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">docs</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">bob</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">Perm</span><span class="p">.</span><span class="na">VIEW</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Bob lists Docs</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bob children of Docs: &quot;</span><span class="o">+</span><span class="n">api</span><span class="p">.</span><span class="na">getChildren</span><span class="p">(</span><span class="n">bob</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">docs</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Search</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Search &#39;Design&#39; as Bob: &quot;</span><span class="o">+</span><span class="n">api</span><span class="p">.</span><span class="na">getSearch</span><span class="p">(</span><span class="n">bob</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Design&quot;</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Rename &amp; move (owner only)</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">putRename</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;DesignSpec_v2.md&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">putMove</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">pics</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Trash &amp; restore</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">deleteNode</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">pics</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;After trash, children root: &quot;</span><span class="o">+</span><span class="n">api</span><span class="p">.</span><span class="na">getChildren</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">));</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postRestore</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">pics</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;After restore, children root: &quot;</span><span class="o">+</span><span class="n">api</span><span class="p">.</span><span class="na">getChildren</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="instagram-feed">Instagram Feed<a class="headerlink" href="#instagram-feed" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>/*
Template -&gt;
1) define functional requirements
   - Users can follow/unfollow others.
   - Users create posts with media + caption; like/comment a post.
   - Generate home feed for a user from followed users’ posts.
   - Ranking = recency + lightweight engagement (likes/comments) signal.
   - Pagination with cursor (createdAt + postId).
   - Simple fan-out-on-read (compute feed on request), add basic cache with TTL.
   - In-memory, thread-safe where needed; doable in ~40 minutes.

2) define entities / actors
   Actors: User (viewer/creator)
   Entities: User, Post, Like, Comment, FollowEdge, FeedEntry (cached)

3) define apis - get/post/put, request, response
   POST   /users                             {username} -&gt; {userId}
   POST   /users/{id}/follow                 {targetUserId} -&gt; {status}
   DELETE /users/{id}/follow                 {targetUserId} -&gt; {status}
   POST   /posts                             {authorId, caption, mediaUrl?} -&gt; {postId}
   POST   /posts/{id}/like                   {userId} -&gt; {likes}
   POST   /posts/{id}/comment                {userId, text} -&gt; {commentId}
   GET    /feed                              {userId, cursor?, limit} -&gt; {items:[...], nextCursor?}

4) define services involved
   UserService        - create users, follow/unfollow.
   PostService        - create posts; like/comment; read post stats.
   GraphService       - read follow graph (who I follow).
   FeedService        - build/rank/paginate feed; small cache with TTL.
   IdGenerator        - generate IDs.

5) define db schema - what all tables are required, what are the columns, what are the keys
   user(id PK, username UNIQUE, created_at)
   follow(user_id FK, target_user_id FK, created_at)  UNIQUE(user_id, target_user_id)
   post(id PK, author_id FK, caption, media_url, created_at)
   like(id PK, post_id FK, user_id FK, created_at)    UNIQUE(post_id, user_id)
   comment(id PK, post_id FK, user_id FK, text, created_at)
   (feed cache not persisted: user_id -&gt; [post_id, score, cached_at])
*/
</code></pre></div>
<h3 id="java-implementation_6">Java Implementation<a class="headerlink" href="#java-implementation_6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">Template -&gt;</span>
<span class="cm">1) define functional requirements</span>
<span class="cm">   - Users can follow/unfollow others.</span>
<span class="cm">   - Users create posts with media + caption; like/comment a post.</span>
<span class="cm">   - Generate home feed for a user from followed users’ posts.</span>
<span class="cm">   - Ranking = recency + lightweight engagement (likes/comments) signal.</span>
<span class="cm">   - Pagination with cursor (createdAt + postId).</span>
<span class="cm">   - Simple fan-out-on-read (compute feed on request), add basic cache with TTL.</span>
<span class="cm">   - In-memory, thread-safe where needed; doable in ~40 minutes.</span>

<span class="cm">2) define entities / actors</span>
<span class="cm">   Actors: User (viewer/creator)</span>
<span class="cm">   Entities: User, Post, Like, Comment, FollowEdge, FeedEntry (cached)</span>

<span class="cm">3) define apis - get/post/put, request, response</span>
<span class="cm">   POST   /users                             {username} -&gt; {userId}</span>
<span class="cm">   POST   /users/{id}/follow                 {targetUserId} -&gt; {status}</span>
<span class="cm">   DELETE /users/{id}/follow                 {targetUserId} -&gt; {status}</span>
<span class="cm">   POST   /posts                             {authorId, caption, mediaUrl?} -&gt; {postId}</span>
<span class="cm">   POST   /posts/{id}/like                   {userId} -&gt; {likes}</span>
<span class="cm">   POST   /posts/{id}/comment                {userId, text} -&gt; {commentId}</span>
<span class="cm">   GET    /feed                              {userId, cursor?, limit} -&gt; {items:[...], nextCursor?}</span>

<span class="cm">4) define services involved</span>
<span class="cm">   UserService        - create users, follow/unfollow.</span>
<span class="cm">   PostService        - create posts; like/comment; read post stats.</span>
<span class="cm">   GraphService       - read follow graph (who I follow).</span>
<span class="cm">   FeedService        - build/rank/paginate feed; small cache with TTL.</span>
<span class="cm">   IdGenerator        - generate IDs.</span>

<span class="cm">5) define db schema - what all tables are required, what are the columns, what are the keys</span>
<span class="cm">   user(id PK, username UNIQUE, created_at)</span>
<span class="cm">   follow(user_id FK, target_user_id FK, created_at)  UNIQUE(user_id, target_user_id)</span>
<span class="cm">   post(id PK, author_id FK, caption, media_url, created_at)</span>
<span class="cm">   like(id PK, post_id FK, user_id FK, created_at)    UNIQUE(post_id, user_id)</span>
<span class="cm">   comment(id PK, post_id FK, user_id FK, text, created_at)</span>
<span class="cm">   (feed cache not persisted: user_id -&gt; [post_id, score, cached_at])</span>
<span class="cm">*/</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="cm">/* ===== Domain ===== */</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">u</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">username</span><span class="o">=</span><span class="n">u</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Post</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">authorId</span><span class="p">,</span><span class="w"> </span><span class="n">caption</span><span class="p">,</span><span class="w"> </span><span class="n">mediaUrl</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">likes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="p">.</span><span class="na">newKeySet</span><span class="p">();</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">comments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">synchronizedList</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">());</span>
<span class="w">    </span><span class="n">Post</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">authorId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">caption</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">mediaUrl</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">authorId</span><span class="o">=</span><span class="n">authorId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">mediaUrl</span><span class="o">=</span><span class="n">mediaUrl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Comment</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="n">Comment</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">postId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">postId</span><span class="o">=</span><span class="n">postId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">userId</span><span class="o">=</span><span class="n">userId</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">text</span><span class="o">=</span><span class="n">text</span><span class="p">;}</span>
<span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FollowEdge</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">targetUserId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="n">FollowEdge</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">t</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">userId</span><span class="o">=</span><span class="n">u</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">targetUserId</span><span class="o">=</span><span class="n">t</span><span class="p">;}</span>
<span class="p">}</span>

<span class="cm">/* ===== Ids ===== */</span>
<span class="kd">class</span> <span class="nc">Ids</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">n</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* ===== Repos (in-memory) ===== */</span>
<span class="kd">class</span> <span class="nc">UserRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">byId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">byUsername</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">u</span><span class="p">){</span><span class="w"> </span><span class="n">byId</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">u</span><span class="p">);</span><span class="w"> </span><span class="n">byUsername</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="na">username</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="na">id</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">u</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">byId</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">uname</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">byUsername</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">uname</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">byId</span><span class="p">::</span><span class="n">get</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">FollowRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// adjacency list: follower -&gt; set of followees</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">follow</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">targetId</span><span class="p">){</span>
<span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">ConcurrentHashMap</span><span class="p">.</span><span class="na">newKeySet</span><span class="p">());</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">userId</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">targetId</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">unfollow</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">targetId</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="p">.</span><span class="na">of</span><span class="p">()).</span><span class="na">remove</span><span class="p">(</span><span class="n">targetId</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">following</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="p">.</span><span class="na">of</span><span class="p">()));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">PostRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Post</span><span class="o">&gt;</span><span class="w"> </span><span class="n">byId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// author -&gt; posts sorted newest first (we’ll keep as list and sort on read for simplicity)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">byAuthor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="n">Post</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Post</span><span class="w"> </span><span class="n">p</span><span class="p">){</span>
<span class="w">        </span><span class="n">byId</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="n">byAuthor</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">authorId</span><span class="p">,</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">Collections</span><span class="p">.</span><span class="na">synchronizedList</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">())).</span><span class="na">add</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">byId</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byAuthors</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorIds</span><span class="p">){</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="n">authorIds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">all</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">byAuthor</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">()));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// newest first</span>
<span class="w">        </span><span class="n">all</span><span class="p">.</span><span class="na">sort</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparing</span><span class="p">((</span><span class="n">Post</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="na">createdAt</span><span class="p">).</span><span class="na">reversed</span><span class="p">().</span><span class="na">thenComparing</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">all</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Services ===== */</span>
<span class="kd">class</span> <span class="nc">UserService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">UserRepo</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FollowRepo</span><span class="w"> </span><span class="n">follows</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">UserService</span><span class="p">(</span><span class="n">UserRepo</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">FollowRepo</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">users</span><span class="o">=</span><span class="n">u</span><span class="p">;</span><span class="n">follows</span><span class="o">=</span><span class="n">f</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>
<span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">users</span><span class="p">.</span><span class="na">byUsername</span><span class="p">(</span><span class="n">username</span><span class="p">).</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;username taken&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;u&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">username</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">follow</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">target</span><span class="p">){</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">target</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">follows</span><span class="p">.</span><span class="na">follow</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">unfollow</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">target</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">follows</span><span class="p">.</span><span class="na">unfollow</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">following</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">follows</span><span class="p">.</span><span class="na">following</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">PostService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PostRepo</span><span class="w"> </span><span class="n">posts</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">PostService</span><span class="p">(</span><span class="n">PostRepo</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">posts</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Post</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">authorId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">caption</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">mediaUrl</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Post</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">authorId</span><span class="p">,</span><span class="w"> </span><span class="n">caption</span><span class="p">,</span><span class="w"> </span><span class="n">mediaUrl</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">like</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Post</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">postId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;post not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="na">likes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">likes</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Comment</span><span class="w"> </span><span class="nf">comment</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="p">){</span>
<span class="w">        </span><span class="n">Post</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">postId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;post not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">Comment</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Comment</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">);</span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="na">comments</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">postsForAuthors</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authors</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="na">byAuthors</span><span class="p">(</span><span class="n">authors</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Feed Cache ===== */</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FeedEntry</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">postId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">score</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">cachedAt</span><span class="o">=</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span><span class="w"> </span><span class="n">FeedEntry</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">s</span><span class="p">){</span><span class="n">postId</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="n">score</span><span class="o">=</span><span class="n">s</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>

<span class="kd">class</span> <span class="nc">FeedCache</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// userId -&gt; (entries sorted desc by score); plus cursor material</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">TTL_SEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span><span class="w"> </span><span class="c1">// small TTL</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FeedEntry</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="o">&gt;</span><span class="w"> </span><span class="n">createdAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">FeedEntry</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Instant</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createdAt</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ts</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">isAfter</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="na">plusSeconds</span><span class="p">(</span><span class="n">TTL_SEC</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">invalidate</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">()));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FeedEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entries</span><span class="p">){</span>
<span class="w">        </span><span class="n">cache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">entries</span><span class="p">);</span><span class="w"> </span><span class="n">createdAt</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">invalidate</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="n">createdAt</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Feed Service ===== */</span>
<span class="kd">class</span> <span class="nc">FeedService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PostService</span><span class="w"> </span><span class="n">posts</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FeedCache</span><span class="w"> </span><span class="n">cache</span><span class="p">;</span>

<span class="w">    </span><span class="n">FeedService</span><span class="p">(</span><span class="n">UserService</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">PostService</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">FeedCache</span><span class="w"> </span><span class="n">cache</span><span class="p">){</span><span class="n">users</span><span class="o">=</span><span class="n">u</span><span class="p">;</span><span class="w"> </span><span class="n">posts</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">;}</span>

<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FeedItem</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">authorId</span><span class="p">,</span><span class="w"> </span><span class="n">caption</span><span class="p">,</span><span class="w"> </span><span class="n">mediaUrl</span><span class="p">;</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">createdAt</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">likeCount</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">commentCount</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">score</span><span class="p">;</span>
<span class="w">        </span><span class="n">FeedItem</span><span class="p">(</span><span class="n">Post</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">score</span><span class="p">){</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">postId</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="na">id</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">authorId</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="na">authorId</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">caption</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="na">caption</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">mediaUrl</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="na">mediaUrl</span><span class="p">;</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">createdAt</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="na">createdAt</span><span class="p">;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">likeCount</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="na">likes</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">commentCount</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="na">comments</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">score</span><span class="o">=</span><span class="n">score</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">toString</span><span class="p">(){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;{post=%s by=%s likes=%d comments=%d score=%.2f}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">authorId</span><span class="p">,</span><span class="w"> </span><span class="n">likeCount</span><span class="p">,</span><span class="w"> </span><span class="n">commentCount</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Rank = w1 * freshness + w2 * likes + w3 * comments</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="n">Post</span><span class="w"> </span><span class="n">p</span><span class="p">){</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">between</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">createdAt</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">()).</span><span class="na">toMinutes</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">recency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hours</span><span class="p">);</span><span class="w">               </span><span class="c1">// decays with time</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">likeBoost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">likes</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">     </span><span class="c1">// diminishing returns</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">commentBoost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">comments</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">0.7</span><span class="o">*</span><span class="n">recency</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.2</span><span class="o">*</span><span class="n">likeBoost</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span><span class="o">*</span><span class="n">commentBoost</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Build or read cached feed, then paginate by cursor (createdAt|postId).</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FeedItem</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getFeed</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cursor</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">){</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FeedEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">userId</span><span class="p">).</span><span class="na">orElseGet</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">following</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authors</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Set</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="c1">// fallback to self posts</span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="w"> </span><span class="n">candidates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="na">postsForAuthors</span><span class="p">(</span><span class="n">authors</span><span class="p">);</span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FeedEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ranked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">candidates</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FeedEntry</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">sorted</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparingDouble</span><span class="p">((</span><span class="n">FeedEntry</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="na">score</span><span class="p">).</span><span class="na">reversed</span><span class="p">()</span>
<span class="w">                            </span><span class="p">.</span><span class="na">thenComparing</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">posts</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">postId</span><span class="p">).</span><span class="na">get</span><span class="p">().</span><span class="na">createdAt</span><span class="p">,</span><span class="w"> </span><span class="n">Comparator</span><span class="p">.</span><span class="na">reverseOrder</span><span class="p">())</span>
<span class="w">                            </span><span class="p">.</span><span class="na">thenComparing</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="na">postId</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">            </span><span class="n">cache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">ranked</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ranked</span><span class="p">;</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Cursor decoding: createdAt|postId of last item returned previously.</span>
<span class="w">        </span><span class="n">Instant</span><span class="w"> </span><span class="n">afterCreated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">afterPostId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cursor</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cursor</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cursor</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;\\|&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">            </span><span class="n">afterCreated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">ofEpochMilli</span><span class="p">(</span><span class="n">Long</span><span class="p">.</span><span class="na">parseLong</span><span class="p">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">));</span>
<span class="w">            </span><span class="n">afterPostId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FeedItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">collected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">FeedEntry</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">entries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Post</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">postId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">afterCreated</span><span class="o">!=</span><span class="kc">null</span><span class="p">){</span>
<span class="w">                </span><span class="c1">// skip until we pass the cursor (compare by createdAt desc then postId)</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">createdAt</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">afterCreated</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmp</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">afterPostId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// exact cursor</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmp</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// p is newer than cursor; skip because we already served it earlier (descending order)</span>
<span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FeedItem</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">score</span><span class="p">));</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">collected</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">nextCursor</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">FeedItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="n">FeedItem</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">page</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">last</span><span class="p">.</span><span class="na">createdAt</span><span class="p">.</span><span class="na">toEpochMilli</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">last</span><span class="p">.</span><span class="na">postId</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">invalidate</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="na">invalidate</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Controller (API Facade) ===== */</span>
<span class="kd">class</span> <span class="nc">FeedController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PostService</span><span class="w"> </span><span class="n">posts</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FeedService</span><span class="w"> </span><span class="n">feed</span><span class="p">;</span>

<span class="w">    </span><span class="n">FeedController</span><span class="p">(</span><span class="n">UserService</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">PostService</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">FeedService</span><span class="w"> </span><span class="n">f</span><span class="p">){</span><span class="n">users</span><span class="o">=</span><span class="n">u</span><span class="p">;</span><span class="n">posts</span><span class="o">=</span><span class="n">p</span><span class="p">;</span><span class="n">feed</span><span class="o">=</span><span class="n">f</span><span class="p">;}</span>

<span class="w">    </span><span class="c1">// Users</span>
<span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">postUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">username</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">postFollow</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">target</span><span class="p">){</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="n">users</span><span class="p">.</span><span class="na">follow</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="n">target</span><span class="p">);</span><span class="w"> </span><span class="n">feed</span><span class="p">.</span><span class="na">invalidate</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">deleteFollow</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">target</span><span class="p">){</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="n">users</span><span class="p">.</span><span class="na">unfollow</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="n">target</span><span class="p">);</span><span class="w"> </span><span class="n">feed</span><span class="p">.</span><span class="na">invalidate</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Posts</span>
<span class="w">    </span><span class="n">Post</span><span class="w"> </span><span class="nf">postCreate</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">authorId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">caption</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">mediaUrl</span><span class="p">){</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="n">posts</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">authorId</span><span class="p">,</span><span class="w"> </span><span class="n">caption</span><span class="p">,</span><span class="w"> </span><span class="n">mediaUrl</span><span class="p">);</span><span class="w"> </span><span class="n">feed</span><span class="p">.</span><span class="na">invalidate</span><span class="p">(</span><span class="n">authorId</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">postLike</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">){</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">posts</span><span class="p">.</span><span class="na">like</span><span class="p">(</span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Comment</span><span class="w"> </span><span class="nf">postComment</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="na">comment</span><span class="p">(</span><span class="n">postId</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Feed</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getFeed</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cursor</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">){</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FeedService</span><span class="p">.</span><span class="na">FeedItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">feed</span><span class="p">.</span><span class="na">getFeed</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">cursor</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">feed</span><span class="p">.</span><span class="na">nextCursor</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">items</span><span class="p">);</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;nextCursor&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Demo (tiny) ===== */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InstagramFeed40Min</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ids</span><span class="p">();</span>
<span class="w">        </span><span class="n">UserRepo</span><span class="w"> </span><span class="n">userRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">FollowRepo</span><span class="w"> </span><span class="n">followRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FollowRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">PostRepo</span><span class="w"> </span><span class="n">postRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PostRepo</span><span class="p">();</span>

<span class="w">        </span><span class="n">UserService</span><span class="w"> </span><span class="n">userSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserService</span><span class="p">(</span><span class="n">userRepo</span><span class="p">,</span><span class="w"> </span><span class="n">followRepo</span><span class="p">,</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">PostService</span><span class="w"> </span><span class="n">postSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PostService</span><span class="p">(</span><span class="n">postRepo</span><span class="p">,</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">FeedCache</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FeedCache</span><span class="p">();</span>
<span class="w">        </span><span class="n">FeedService</span><span class="w"> </span><span class="n">feedSvc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FeedService</span><span class="p">(</span><span class="n">userSvc</span><span class="p">,</span><span class="w"> </span><span class="n">postSvc</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">);</span>
<span class="w">        </span><span class="n">FeedController</span><span class="w"> </span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FeedController</span><span class="p">(</span><span class="n">userSvc</span><span class="p">,</span><span class="w"> </span><span class="n">postSvc</span><span class="p">,</span><span class="w"> </span><span class="n">feedSvc</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Users</span>
<span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">alice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postUser</span><span class="p">(</span><span class="s">&quot;alice&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">bob</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postUser</span><span class="p">(</span><span class="s">&quot;bob&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">carol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postUser</span><span class="p">(</span><span class="s">&quot;carol&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Graph</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postFollow</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">bob</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postFollow</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">carol</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Posts</span>
<span class="w">        </span><span class="n">Post</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postCreate</span><span class="p">(</span><span class="n">bob</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sunset at the beach&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://img/1.jpg&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">        </span><span class="n">Post</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postCreate</span><span class="p">(</span><span class="n">carol</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Coffee ☕️&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">        </span><span class="n">Post</span><span class="w"> </span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postCreate</span><span class="p">(</span><span class="n">bob</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Morning run 5k&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Engagement to influence ranking</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postLike</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postLike</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">carol</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postComment</span><span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Looks great!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">postLike</span><span class="p">(</span><span class="n">p3</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Feed page 1</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getFeed</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;FEED page1: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">page1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">page1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;nextCursor&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Feed page 2</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">getFeed</span><span class="p">(</span><span class="n">alice</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">cursor</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;FEED page2: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">page2</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="meeting-scheduler">Meeting Scheduler<a class="headerlink" href="#meeting-scheduler" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>/*
Template -&gt;
1) define functional requirements
   - Schedule meetings between participants with date/time/duration.
   - Check participants’ availability across their calendars.
   - Book meeting room/resource if needed.
   - Update/cancel meeting, notify attendees.
   - Query list of meetings for a user.
   - In-memory, concurrency-light, simple design for 40-min interview.

2) define entities / actors
   Actors: User, CalendarService (integration stub)
   Entities: User, Meeting, MeetingRoom, Invitation

3) define apis - get/post/put, request, response
   GET  /users/{id}/meetings?day=2025-08-21
        -&gt; [{meetingId, start, end, participants}]
   POST /meetings
        {organizerId, participantIds:[...], start, end, roomId?}
        -&gt; {meetingId, status}
   PUT  /meetings/{id}
        {start?, end?, roomId?} -&gt; {status}
   DELETE /meetings/{id}
        -&gt; {status}
   POST /meetings/{id}/cancel
        -&gt; {status}

4) define services involved
   AvailabilityService  - check if users/rooms free in requested slot.
   MeetingService       - create/update/cancel meetings.
   NotificationService  - (stub) notify participants.
   RoomService          - manage meeting rooms.
   IdGenerator          - generate IDs.

5) define db schema - what all tables are required, what are the columns, what are the keys
   user(id PK, name, email)
   meeting(id PK, organizer_id FK, start_at, end_at, room_id FK NULL, status)
   meeting_participant(meeting_id FK, user_id FK, response ENUM)
   meeting_room(id PK, name, capacity)
*/
</code></pre></div>
<h3 id="java-implementation_7">Java Implementation<a class="headerlink" href="#java-implementation_7" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">Template -&gt;</span>
<span class="cm">1) define functional requirements</span>
<span class="cm">   - Schedule meetings between participants with date/time/duration.</span>
<span class="cm">   - Check participants’ availability across their calendars.</span>
<span class="cm">   - Book meeting room/resource if needed.</span>
<span class="cm">   - Update/cancel meeting, notify attendees.</span>
<span class="cm">   - Query list of meetings for a user.</span>
<span class="cm">   - In-memory, concurrency-light, simple design for 40-min interview.</span>

<span class="cm">2) define entities / actors</span>
<span class="cm">   Actors: User, CalendarService (integration stub)</span>
<span class="cm">   Entities: User, Meeting, MeetingRoom, Invitation</span>

<span class="cm">3) define apis - get/post/put, request, response</span>
<span class="cm">   GET  /users/{id}/meetings?day=2025-08-21</span>
<span class="cm">        -&gt; [{meetingId, start, end, participants}]</span>
<span class="cm">   POST /meetings</span>
<span class="cm">        {organizerId, participantIds:[...], start, end, roomId?}</span>
<span class="cm">        -&gt; {meetingId, status}</span>
<span class="cm">   PUT  /meetings/{id}</span>
<span class="cm">        {start?, end?, roomId?} -&gt; {status}</span>
<span class="cm">   DELETE /meetings/{id}</span>
<span class="cm">        -&gt; {status}</span>
<span class="cm">   POST /meetings/{id}/cancel</span>
<span class="cm">        -&gt; {status}</span>

<span class="cm">4) define services involved</span>
<span class="cm">   AvailabilityService  - check if users/rooms free in requested slot.</span>
<span class="cm">   MeetingService       - create/update/cancel meetings.</span>
<span class="cm">   NotificationService  - (stub) notify participants.</span>
<span class="cm">   RoomService          - manage meeting rooms.</span>
<span class="cm">   IdGenerator          - generate IDs.</span>

<span class="cm">5) define db schema - what all tables are required, what are the columns, what are the keys</span>
<span class="cm">   user(id PK, name, email)</span>
<span class="cm">   meeting(id PK, organizer_id FK, start_at, end_at, room_id FK NULL, status)</span>
<span class="cm">   meeting_participant(meeting_id FK, user_id FK, response ENUM)</span>
<span class="cm">   meeting_room(id PK, name, capacity)</span>
<span class="cm">*/</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="cm">/* ===== Domain ===== */</span>
<span class="kd">enum</span><span class="w"> </span><span class="n">MeetingStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">SCHEDULED</span><span class="p">,</span><span class="w"> </span><span class="n">CANCELLED</span><span class="w"> </span><span class="p">}</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">;</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="n">email</span><span class="o">=</span><span class="n">e</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MeetingRoom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">capacity</span><span class="p">;</span><span class="w"> </span><span class="n">MeetingRoom</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">;</span><span class="n">capacity</span><span class="o">=</span><span class="n">c</span><span class="p">;}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Meeting</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">organizerId</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">participants</span><span class="p">;</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">roomId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">volatile</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">MeetingStatus</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="n">MeetingStatus</span><span class="p">.</span><span class="na">SCHEDULED</span><span class="p">;</span>
<span class="w">    </span><span class="n">Meeting</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">org</span><span class="p">,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parts</span><span class="p">,</span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">roomId</span><span class="p">){</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">organizerId</span><span class="o">=</span><span class="n">org</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">participants</span><span class="o">=</span><span class="n">parts</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">start</span><span class="o">=</span><span class="n">s</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">end</span><span class="o">=</span><span class="n">e</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">roomId</span><span class="o">=</span><span class="n">roomId</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Repos ===== */</span>
<span class="kd">class</span> <span class="nc">Ids</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">p</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">n</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">();}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">UserRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">u</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">u</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">u</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">RoomRepo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">MeetingRoom</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="n">MeetingRoom</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">MeetingRoom</span><span class="w"> </span><span class="n">r</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">r</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;}</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">MeetingRoom</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span><span class="w"> </span><span class="p">}</span>
<span class="kd">class</span> <span class="nc">MeetingRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Meeting</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">Meeting</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Meeting</span><span class="w"> </span><span class="n">x</span><span class="p">){</span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Meeting</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">));}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Meeting</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">byUserAndDay</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">d</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">mt</span><span class="o">-&gt;</span><span class="n">mt</span><span class="p">.</span><span class="na">participants</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mt</span><span class="p">.</span><span class="na">organizerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">mt</span><span class="o">-&gt;</span><span class="n">mt</span><span class="p">.</span><span class="na">start</span><span class="p">.</span><span class="na">toLocalDate</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Services ===== */</span>
<span class="kd">class</span> <span class="nc">AvailabilityService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MeetingRepo</span><span class="w"> </span><span class="n">meetings</span><span class="p">;</span>
<span class="w">    </span><span class="n">AvailabilityService</span><span class="p">(</span><span class="n">MeetingRepo</span><span class="w"> </span><span class="n">m</span><span class="p">){</span><span class="n">meetings</span><span class="o">=</span><span class="n">m</span><span class="p">;}</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isUserAvailable</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">e</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">meetings</span><span class="p">.</span><span class="na">m</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">mt</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">mt</span><span class="p">.</span><span class="na">participants</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mt</span><span class="p">.</span><span class="na">organizerId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mt</span><span class="p">.</span><span class="na">status</span><span class="o">==</span><span class="n">MeetingStatus</span><span class="p">.</span><span class="na">SCHEDULED</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">mt</span><span class="o">-&gt;</span><span class="n">overlap</span><span class="p">(</span><span class="n">mt</span><span class="p">.</span><span class="na">start</span><span class="p">,</span><span class="w"> </span><span class="n">mt</span><span class="p">.</span><span class="na">end</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">overlap</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">e2</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="n">e1</span><span class="p">.</span><span class="na">isBefore</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">e2</span><span class="p">.</span><span class="na">isBefore</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">MeetingService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MeetingRepo</span><span class="w"> </span><span class="n">meetings</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AvailabilityService</span><span class="w"> </span><span class="n">avail</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="n">MeetingService</span><span class="p">(</span><span class="n">MeetingRepo</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">AvailabilityService</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="p">){</span><span class="n">meetings</span><span class="o">=</span><span class="n">m</span><span class="p">;</span><span class="n">avail</span><span class="o">=</span><span class="n">a</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="na">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">;}</span>
<span class="w">    </span><span class="n">Meeting</span><span class="w"> </span><span class="nf">schedule</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">org</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parts</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">roomId</span><span class="p">){</span>
<span class="w">        </span><span class="c1">// check availability</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">avail</span><span class="p">.</span><span class="na">isUserAvailable</span><span class="p">(</span><span class="n">org</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Organizer busy&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">u</span><span class="p">:</span><span class="w"> </span><span class="n">parts</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">avail</span><span class="p">.</span><span class="na">isUserAvailable</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;User busy: &quot;</span><span class="o">+</span><span class="n">u</span><span class="p">);</span>
<span class="w">        </span><span class="n">Meeting</span><span class="w"> </span><span class="n">mt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Meeting</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;mt&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">org</span><span class="p">,</span><span class="w"> </span><span class="n">parts</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">roomId</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">meetings</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">mt</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Meeting</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">ne</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">roomId</span><span class="p">){</span>
<span class="w">        </span><span class="n">Meeting</span><span class="w"> </span><span class="n">mt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meetings</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">id</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="o">-&gt;</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;not found&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">mt</span><span class="p">.</span><span class="na">start</span><span class="o">=</span><span class="n">ns</span><span class="o">!=</span><span class="kc">null</span><span class="o">?</span><span class="n">ns</span><span class="p">:</span><span class="n">mt</span><span class="p">.</span><span class="na">start</span><span class="p">;</span><span class="w"> </span><span class="n">mt</span><span class="p">.</span><span class="na">end</span><span class="o">=</span><span class="n">ne</span><span class="o">!=</span><span class="kc">null</span><span class="o">?</span><span class="n">ne</span><span class="p">:</span><span class="n">mt</span><span class="p">.</span><span class="na">end</span><span class="p">;</span>
<span class="w">        </span><span class="n">mt</span><span class="p">.</span><span class="na">status</span><span class="o">=</span><span class="n">MeetingStatus</span><span class="p">.</span><span class="na">SCHEDULED</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">meetings</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">mt</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span>
<span class="w">        </span><span class="n">meetings</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">id</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">mt</span><span class="o">-&gt;</span><span class="n">mt</span><span class="p">.</span><span class="na">status</span><span class="o">=</span><span class="n">MeetingStatus</span><span class="p">.</span><span class="na">CANCELLED</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Controller Facade ===== */</span>
<span class="kd">class</span> <span class="nc">MeetingController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MeetingService</span><span class="w"> </span><span class="n">service</span><span class="p">;</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MeetingRepo</span><span class="w"> </span><span class="n">repo</span><span class="p">;</span>
<span class="w">    </span><span class="n">MeetingController</span><span class="p">(</span><span class="n">MeetingService</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">MeetingRepo</span><span class="w"> </span><span class="n">r</span><span class="p">){</span><span class="n">service</span><span class="o">=</span><span class="n">s</span><span class="p">;</span><span class="n">repo</span><span class="o">=</span><span class="n">r</span><span class="p">;}</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Meeting</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getUserMeetings</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">d</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">repo</span><span class="p">.</span><span class="na">byUserAndDay</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">d</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Meeting</span><span class="w"> </span><span class="nf">postMeeting</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">org</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parts</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">roomId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="na">schedule</span><span class="p">(</span><span class="n">org</span><span class="p">,</span><span class="n">parts</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">roomId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">Meeting</span><span class="w"> </span><span class="nf">putMeeting</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">ne</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">roomId</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">ns</span><span class="p">,</span><span class="n">ne</span><span class="p">,</span><span class="n">roomId</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">deleteMeeting</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="na">cancel</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ===== Demo ===== */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MeetingScheduler40Min</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Ids</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ids</span><span class="p">();</span>
<span class="w">        </span><span class="n">UserRepo</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">RoomRepo</span><span class="w"> </span><span class="n">rooms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RoomRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">MeetingRepo</span><span class="w"> </span><span class="n">meetings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MeetingRepo</span><span class="p">();</span>
<span class="w">        </span><span class="n">AvailabilityService</span><span class="w"> </span><span class="n">avail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AvailabilityService</span><span class="p">(</span><span class="n">meetings</span><span class="p">);</span>
<span class="w">        </span><span class="n">MeetingService</span><span class="w"> </span><span class="n">svc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MeetingService</span><span class="p">(</span><span class="n">meetings</span><span class="p">,</span><span class="w"> </span><span class="n">avail</span><span class="p">,</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span>
<span class="w">        </span><span class="n">MeetingController</span><span class="w"> </span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MeetingController</span><span class="p">(</span><span class="n">svc</span><span class="p">,</span><span class="w"> </span><span class="n">meetings</span><span class="p">);</span>

<span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">u1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;u&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Alice&quot;</span><span class="p">,</span><span class="s">&quot;a@x.com&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">u2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;u&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Bob&quot;</span><span class="p">,</span><span class="s">&quot;b@x.com&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">rooms</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MeetingRoom</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="s">&quot;room&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Conf A&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">));</span>

<span class="w">        </span><span class="n">Meeting</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">postMeeting</span><span class="p">(</span><span class="n">u1</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">u2</span><span class="p">.</span><span class="na">id</span><span class="p">),</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">plusHours</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">plusHours</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Scheduled meeting: &quot;</span><span class="o">+</span><span class="n">m1</span><span class="p">.</span><span class="na">id</span><span class="o">+</span><span class="s">&quot; participants=&quot;</span><span class="o">+</span><span class="n">m1</span><span class="p">.</span><span class="na">participants</span><span class="p">);</span>

<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Meetings for Bob today: &quot;</span><span class="o">+</span><span class="n">api</span><span class="p">.</span><span class="na">getUserMeetings</span><span class="p">(</span><span class="n">u2</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDate</span><span class="p">.</span><span class="na">now</span><span class="p">()));</span>

<span class="w">        </span><span class="n">api</span><span class="p">.</span><span class="na">deleteMeeting</span><span class="p">(</span><span class="n">m1</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Cancelled meeting. Status=&quot;</span><span class="o">+</span><span class="n">meetings</span><span class="p">.</span><span class="na">byId</span><span class="p">(</span><span class="n">m1</span><span class="p">.</span><span class="na">id</span><span class="p">).</span><span class="na">get</span><span class="p">().</span><span class="na">status</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections", "navigation.top", "search.suggest", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>